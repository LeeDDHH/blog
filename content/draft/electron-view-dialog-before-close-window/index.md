---
title: 【electron】画面を閉じる/アプリを終了する際に確認のダイアログを表示する
date: "2021-07-03 15:00:00"
description: "electronで画面/アプリの終了をする際に確認用のダイアログを表示させる実装方法について簡単にまとめた"
---

<!--
構成について

記事のモチベーション
プロダクト実装で、特定のウィンドウを閉じようとするときに確認用のダイアログを表示させる必要があった
今回は、実装前に想定した点と実装したときのポイントについてまとめる

実装時の要件
1. ウィンドウを閉じるときに確認のダイアログを表示する
1-1. 閉じることを確定したら、ウィンドウを閉じる
1-2. キャンセルしたら、ウィンドウをそのままにする
2. アプリを終了するときにウィンドウを開いている状態なら終了前に確認のダイアログを表示する
2-1. 閉じることを確定したら、ウィンドウを閉じてアプリを終了する
2-2. キャンセルしたら、ウィンドウをそのままにして、アプリの終了をしない

実装前に想定した点
想定していた方法だとウィンドウの `close` イベントの前後で実装できると思っていたが、そうとは行かなかった

`close` イベントの前後の制御で困難だった点
1. そもそもウィンドウの `close` イベントよりも前に制御するイベントがなかった
1-1. electronの `app` の `will-quit` , `before-quit` といったような処理があると思っていた
2. ウィンドウの特定の画面を開いている場合、メインプロセス側でウィンドウを閉じる処理をすると同期/非同期に関わらず、キャンセル後にそのウィンドウの操作が効かない
2-1. メインプロセスでなく、フロント側で「window.onbeforeunload」を使って回避する方法もあったけど、１つのウィンドウの複数の画面ごとに適用させることが億劫だった

実際に実装した点
1. ウィンドウフレームの「閉じる」「最小化」を表示させない
2. 画面内で作成した「閉じる」ボタンからウィンドウの `close` イベントを発火させるのではなく、非同期でダイアログを表示する
2-1. キャンセルしたら、 `e.preventDefault` で処理を止める
2-2-1. 閉じる確定をしたら、ウィンドウを `destroy` する
2-2-2. `destroy` をする理由は次に説明する
3. アプリを終了する時に `before-quit` で終了前の処理をする
3-1. `before-quit` の中で ウィンドウが `isVisible` な場合、 `e.preventDefault` をすることで、アプリ終了処理を止める
3-2. 非同期でダイアログを表示し、閉じることを確定したら、 `app.quit` を再度実行する
3-2-1. 特定のウィンドウを閉じる際、 ウィンドウの `close` だと、フロント側で `unload`のイベント処理を加える必要がある
3-2-2. また、 `close` イベントだと、ウィンドウを閉じようとする段階なので、 `app.quit` を再度実行しても、まだ「完全に閉じいている状態」ではないため、ウィンドウにダイアログがちょっと表示されてから閉じることになる
3-2-3. `destroy` だと、 `unload` と `beforeunload` のイベントが発生することやウィンドウの `isVisible` な状態を気にせずに済む
-->

長くなりがちなコマンドを `zsh` の `alias` に指定することは何回もあったが、引数を渡して使うように関数化したことは滅多になかったので設定の仕方を調べてみた

## 引数を指定したコマンドを作成する

### 基本的な関数の設定

基本的な関数の指定は以下のようにできる

```shell
関数名(){実行したいコマンド}

# example
# 9秒間、処理を遅延する
theworld-dio(){sleep 9}
# 【実行コマンド】
# theworld-dio
# 【実行結果】
# 9秒間、処理を遅延する
```

`.zshrc` へ上記のように記載し、 `source .zshrc` をしてからコマンドの確認ができる

### 引数を指定した関数の設定

引数を渡して使う関数の場合は以下のように設定する

```shell
関数名(){実行したいコマンド $1}

# example
# 引数で指定した数値の秒数間、処理を遅延する
theworld-jotaro(){sleep $1}
# 【実行コマンド】
# theworld-jotaro 11
# 【実行結果】
# 11秒間、処理を遅延する
```

基本的な関数の設定と同様、 `source .zshrc` をしてからコマンドの確認ができる

複数の引数を指定したい場合は以下のように設定できる

```shell
関数名(){実行したいコマンド $1 $2 $3 ... }

# example
# 実行時に渡した第1引数が文字列として表示され、第2引数の数値だけ処理が遅延され、最後に既定の文字列が表示される
time-stop-stand(){echo $1 && sleep $2 && echo Toki Wa Ugokidasu }
# 【実行コマンド】
# time-stop-stand Star\ Platinum\ The\ World! 11
# $1がStar\ Platinum\ The\ World!、$2が11
# 【実行結果】
# Star Platinum The World! が表示される
# 11秒間、処理を遅延する
# Toki Wa Ugokidasu が表示される
```

## さいごに

既定のパスにログを吐き出すとか同じオプションで渡す値だけ違うときとかに重宝して使えそうだと思った
