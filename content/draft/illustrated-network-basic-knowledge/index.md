# 図解　ネットワーク　仕事で使える基本の知識［改訂新版］

- これまで気にしていなかったデータの流れを意識すれば、そんなに難しくない
- 複雑に見えても、実は非常に合理的
- ネットワーク、サーバーの構築、管理をしていく上で、知っておきたいネットワーク全体の知識をひととおりまとめる
- ネットワークには多くのサーバーやネットワーク機器が参加している
  - それぞれが役割を分担してデータを運んでいるので、1つの技術を理解するために、ネットワークの基礎知識を持っていることが大切

## 第1章　ネットワークの基礎知識

- プロトコルの概念と仕組み
- LANとインターネットの違い
- ネットワークの形態
- ネットワークへの接続
- サーバーとは何か

### 1　ネットワークの学習は難しい？

- ネットワークを使う側から**提供する管理者の視点**に切り替える
- データの中身ではなく、**データのやり取りの流れを意識する**
  - 「ネットワークにつながっている」状態は、ネットワークを通じてデータをやり取りできる状態にあること
- 各技術や仕組みは**データのやり取りをするためにある**ことを意識する
  - ネットワークの技術や仕組みは、効率よく相手とデータをやり取りすることを最終目的として考え出されている
  - データをやり取りすることが目的

### 2　プロトコルはフォーマットとプロシージャで構成される

- **プロトコル**
  - ネットワークに参加しているコンピューターや機器がデータのやり取りを行うための決まりごと
  - 同じプロトコルに対応していれば、データのやり取りができる
  - 複数のプロトコルをひとまとめにして、**プロトコル群**とも呼ぶ
- プロトコルの構成
  - **フォーマット**
    - 情報構造
    - **データの構成**に関する決まりごと
    - 必要な情報の表記方法や情報のある場所など、やり取りするデータがどのような構成になっているか
  - **プロシージャ**
    - 通信手順
    - **データをやり取りするときの手順**に関する決まりごと
    - データのやり取りを始めるとき、終了する時、エラーが起きたときなどにどうするのか

### 3　プロトコルはレイヤー構造をとる

- レイヤー構造、階層構造
- レイヤーごとのプロトコルに沿って順場に処理する
- それぞれのレイヤーに役割があり、具体的な作業方法、プロトコルの詳細は異なっても役割は同じ
- あるレイヤーのプロトコルを別のものに変えても、他のレイヤーは影響を受けずそのまま使える

### 4　LANとインターネットの違い

- LAN（Local Area Network）
  - 同じ建物や敷地内にあるネットワーク
  - 企業ネットワーク、家庭内ネットワーク
  - 規模にかかわらず、**ネットワーク全体を管理できる**
  - 外部から許可なく勝手に接続することはできない
  - **閉ざされたネットワーク**
- インターネット
  - 複数のコンピューターが役割を分担して全体が機能する分散型ネットワーク
  - **開かれたネットワーク**
  - インターネットの一部分を管理する企業、団体はいるが、全体を把握する管理者はいない
- LANをインターネットに接続し、**LANの中にコンピューターからインターネットを利用できるようにするのが一般的**
- LANとインターネットの大きな違い
  - **全体を把握できるかどうか**

### 6　サーバーはネットワークサービスを提供する

- サーバー
  - クライアントにネットワークサービスを提供する
  - 提供するネットワークサービスの名前に「サーバー」を付けて呼ぶ
- サーバーの構成
  - **ハードウェア**
  - **サーバー用のOS**
  - **ネットワークサービスを提供するためのソフトウェア**
- **アプライアンス**
  - サーバーとして使用するために設計された専用のハードウェア
- サーバーはコンピューターでなくても、プリンターやネットワーク機器に組み込まれているケースも見られる

### 7　インターネットに接続するには

- 全体を管理していないインターネットに接続するにはどうしたらいいのか
  - 個々のコンピューターや機器を特定するために使われる**グローバルIP**を取得する
  - インターネットを形成する個々のネットワークを識別する**AS番号**も必要
  - 回線設備が必要
  - ケーブルの敷設、通信に必要な装備の設置
  - グローバルIPとドメイン名を対応させるDNSサーバー（降るサービスリゾルバー）
- しかし、小規模のネットワークを使う企業や個人の場合、必要な物を提供する**回線事業者**や**ISP**と契約することになる
- **グローバルIP**
  - インターネットで使われる住所みたいなもの
- **ICANN**
  - グローバルIPとAS番号を管理する組織
  - 各国からICANNの委託をうけて管理する
- **JPNIC**
  - 日本で管理業務をするところ

### 9　FTTHの仕組み

- **FTTH**（Fiber To The Home）
  - 光ファイバーを家庭に敷設し、高速で安定したデータ通信を実現する意味
  - 現在では、企業向けを含めた光ファイバー通信サービスの総称
  - インターネット接続に加え、電話、マルチメディア配信などのサービスも合わせて提供する
  - デジタルの電気信号とデジタルの光信号を相互に変換する
- **ADSL**
  - デジタル電気信号とアナログ電気信号を相互に変換する
- ユーザーのコンピューターから送られたデータは、ユーザー宅から光ファイバーを通じてFTTHサービス事業者の収容局に送る
  - さらに、ISPのネットワークからインターネットへ送られる
- ユーザー宅と収容局を結ぶ光ファイバーのつなげ方で以下のように分ける
  - **PON**（Passive Optical Network）
    - 複数のユーザーで共有する方式
    - コストの負担が少なく、家庭用のFTTHサービスで採用される
  - **SS**（Single Star）
    - ユーザーが専有する方式
    - 企業向け
- FTTHを利用するユーザー宅には、電気信号と光信号を変換する装置を設置する
  - **メディアコンバーター**
    - SS方式で使われる
  - **ONU**（Optical Network Unit）
    - PON方式で使われる
- 収容局にもメディアコンバーターが設置されて、電気信号と光信号を変換する
- 最近では、家庭向けのFTTHサービスも普及しつつある

[光ファイバーが速い理由とその仕組み・構造・材質について楠リカがやさしく解説](https://simpc.jp/rikatech/about-optical-fiber/)

---

## 第2章　TCP/IPを知る

- ネットワーク通信の基本的な仕組み
- ネットワークアーキテクチャーを理解し、ネットワークでどのようにデータが扱われ、流れていくか

### 1　ネットワークアーキテクチャーとOSI参照モデル

- ISO（国際標準化機構）が定めたOSI参照モデル
  - データをやり取りするときに必要な決まりごと（プロトコル）を第1~7層までのレイヤー構造で体系的にまとめる

|層|レイヤー|名前|役割|
|:---:|:---:|:---:|:---:|
|上位層|7層|アプリケーション層|**アプリケーションがどのようにデータを処理するか**の決まりごと|
|上位層|6層|プレゼンテーション層|**データの通信に適した形式やアプリケーションが処理する形式に変換する**ための決まりごと|
|上位層|5層|セッション層|**通信プログラムがデータをやり取りをはじめてから終わるまでの一連の流れ（セッション）**に関する決まりごと<br>データをやり取りする相手との間に仮想的な経路を作り、データのやり取りが終われば通路を閉じる|
|下位層|4層|トランスポート層|**データを確実にやり取りする**ための決まりごと<br>データ圧縮、エラー制御、再送機能など|
|下位層|3層|ネットワーク層|**データをやり取りする道筋（経路選択）**の決まりごと<br>最終的にデータをやり取りする相手との決まりごと|
|下位層|2層|データリンク層|**同じネットワーク内でのデータのやり取り**に関する決まりごと<br>ネットワークに直接つながっている相手との決まりごと|
|下位層|1層|物理層|ケーブルの規格、電気信号の条件などの**物理的/電気的**な決まりごと<br>やり取りされるデータは電気的な信号として扱われる|

### 2　回線交換方式とパケット交換方式

- 回線交換方式
  - 回線を専有して通信を行う
  - 大量のデータをやり取りできる
  - データのやり取りが終わるまで、他のユーザーはその回線を使用できない
- パケット交換方式
  - データをパケット単位に分けて送る
  - 回線の途中でいったん蓄積され、回線が空いているときに送る
  - リアルタイムでの通信には不向き
  - 複数のユーザーが同時に回線を使用できるので効率がいい
- パケット交換方式のデータの流れ
  - 分割したデータの先頭にやり取りで必要な情報（**ヘッダー**）をつけて、パケットを作る
  - 1つのパケットは、**データ本体**と**ヘッダー**がセットになる
  - 末尾にトレーラーをつけることもある
  - 受信側はパケットに付いているヘッダーやトレーラー情報をもとに各レイヤーがパケットを結合してデータに戻す
  - 復元されtあデータは次に処理されるレイヤーに渡され、送信側と逆の順番で処理作業が進む

### 3　ネットワーク標準のプロトコル「TCP/IP」

- **TCP/IP**
  - プロトコルを体系的にまとめ、どのようにネットワークを構成するかという基本概念を表したネットワークアーキテクチャーの1つ
- **TCP/IPプロトコル群**
  - アプリケーション層
  - トランスポート層
  - インターネット層
  - ネットワークインタフェイス層
- TCP/IPネットワークでデータをやり取りするとき
  - ネットワークサービス用のソフトウェアと**TCP/IPプロトコルスタック**がデータを処理する
- プロトコルスタック
  - プロトコルで決めている処理を実際に行うためのプログラム群

### 4　ネットワークインターフェイス層の役割

- **ネットワークインターフェイス層**
  - ケーブルや端子の形状、信号の形式など、物理的な決まりごとを定める
  - OSI参照モデルでの**物理層**と**データリンク層**を担当する
- 実際に処理を行うのは、TCP/IPプロトコルスタックとプロトコルに対応したハードウェア
  - TCP/IPプロトコルスタックは、コンピューターや機器間のデータのやり取りに関する決まりごとの処理を行う
- ネットワークインターフェイス層の代表的なプロトコル
  - **イーサネット（Ethernet）**、**PPP**など
- イーサネット
  - 複数のコンピューターや機器が、1つの回線を効率よく使用できる
  - **規格**
    - 物理的な決まりごとのほう
  - **イーサネットプロトコル**
    - データの処理に関する決まりごと
- PPP
  - コンピューターや機器が1対1の関係で接続されている回線で、データをやり取りするためのプロトコル
  - パスワード認証機能がある
  - 最近はあまり使われてない
  - インターネット接続サービスで正規の会員を認証するときに便利
- PPPoE（PPP over Ethernet）
  - PPPとイーサネットの組み合わせ

### 5　インターネット層の役割

- **インターネット層**
  - 最終的にデータをやり取りする相手との通信に関する決まりごとを定める
  - OSI参照モデルの**ネットワーク層**を担当する
- **IP**
  - トランスポート層のTCP/IPプロトコル群の基盤となるプロトコル
- 最終的にデータをやり取りする相手とデータをやり取りするために必要なこと
  - **どのコンピューターや機器が、最終的にデータをやり取りする相手なのか**を指定する
- **IPアドレス**
  - ネットワークの世界の住所のようなもの
  - ネットワークに参加しているすべてのコンピューわーや機器につけることで、データをやり取りする相手の指定ができる
- **経路選択**、**ルーティング**
  - **どのルートを通って行けばたどり着けるのか**を決める
- IPの主な役割は、IPアドレスの管理と経路選択
- インターネット層のプロトコル
  - IP
  - ARP
    - IPアドレスから対応するMACアドレスを調べる役割
  - RARP
    - MACアドレスから対応するIPアドレスを調べる
  - ICMP
    - IPが担当するデータのやり取りにおいて、エラーが発生した場合に対処するプロトコル
    - pingコマンドで使われる
  - など

### 6　トランスポート層の役割

- **トランスポート層**
  - データのやり取りを制御するプロトコル
  - OSI参照モデルの**トランスポート層**と**セッション層の一部**を担当する
- 通信プログラムがデータのやり取りをはじめてから終了するまでの一連の流れ（セッション）を行う仮想的な通路を作る
  - 仮想的な通路は、**同時に複数作ることができる**ので、**どの仮想的な通路で扱うデータなのかを区別する**必要がある
- **ポート番号**
  - 各通信プログラムに識別子として使う
- TCPには、さらに確実にデータを届けるための機能がある
  - **確認応答**
    - データを受信した側が、送信側にデータを受け取ったと知らせる機能
    - 送信側は、受信側からの知らせを受け取ったら、次のデータを送る
  - **再送**
    - 一定期間待っても確認応答がない場合に、再度同じデータを送る機能
  - **シーケンス番号**
    - どこまでのデータが届いたのかがわかるようにつける番号
- 一般的なデータのやり取りでは、確実に届くTCPを使用する
- 動画配信など、転送速度を重視するネットワークサービスではUDPを使用する

### 7　TCPの通信手順

- TCPを使ったデータのやり取り
  - SYN
    - データをやり取りするリクエストを送るセグメント
  - ACK
    - 応答確認のセグメント
- 3ウェイハンドシェイク
  - 送信側（SYN）
  - 受信側（ACK、SYN）
  - 送信側（ACK）
  - 送信/受信側のそれぞれが、セグメントにつけるシーケンス番号の初期値の情報をやり取りする
- データのやり取り時にセグメントを1つ送るたびにACKを送ると効率が悪い
  - なので、複数のセグメントをまとめてやり取りする
  - ただ、一度に受け取れるデータ量には限度があるので、受信側はACKのヘッダーへ**一度に受け取れるデータ量**を記載する
  - 一度に受け取れるデータ量は**ウィンドウサイズ**と呼ぶ
- ACKを受け取った送信側は、送るセグメントがシーケンス番号の何番からはじまるかをヘッダーに記載して送る
  - 受信側は何万まで受け取ったかの用法を記載し、ACKを送る
  - 一定時間待っても受信側からACKが届かなかったら再送する
- セグメントのヘッダーには、送ったセグメントと受け取ったセグメントが同じなのかどうかを検証するための**チェックサム**を含める
  - チェックサムが一致しなかったら、途中で破損したかのうせいがあるので、再送してもらう
- データのやり取りを終了するときは、送信側が**FIN**セグメントを送る
  - 受信側は送信側にACKを返し、その後FINを送る
  - 送信側はACKを送ってデータのやり取りを終了する

### 8　アプリケーション層の役割

- **アプリケーション層**
  - ユーザーにネットワークサービスを提供する
  - ユーザーが作成したデータをアプリケーション層のプロトコルのに沿って整えて、下位のトランスポート層に渡す
  - ユーザーとTCP/IPの橋渡しをしているレイヤー
  - OSI参照モデルの**セッション層**、**プレゼンテーション層**、**アプリケーション層**に相当する
- データのやり取りを行う場合、利用するサービスのプロトコルに対応する必要がある
- **ヘッダー**
  - ユーザーが入力したデータに、受け取る相手のアプリケーション層のプロトコルが正しく処理するのに必要な情報

### 9　TCP/IPネットワークでの各レイヤーの働き

- 上位のレイヤーから渡されたデータはカプセル化される
- TCP/IPの各レイヤーがイーサネットを使ったネットワークでデータをやり取りするときの流れ
  - アプリケーション層
    - 使うサービスのソフトで対応した決まりごとに沿って必要な情報を**ヘッダー**としてつけて、**TCP/IPプロトコルスタック**に渡す
  - トランスポート層
    - トランスポート層のプロトコルに沿って処理をする
    - データを分割して、受信側のTCPが処理を行うときに必要な情報をヘッダーとして付けて、**セグメント**を作る
    - 下位のOSI参照モデルの**トランスポート層**と**セッション層の一部**を担当するの処理に移る
  - インターネット層
    - インターネット層のプロトコル（IP）に沿ってデータを処理する
    - 必要な情報をヘッダーとして付けて、データグラムを作る
    - 下位のネットワークインターフェイス層の処理に移る
  - **カプセル化**
    - 上位の層から受け取ったパケットをひとかたまりのデータとして扱うこと
  - ネットワークインタフェイス層
    - 受け取ったデータグラムをカプセル化し、ネットワークインタフェイス層のプロトコル（イーサネット）に沿って処理する
    - イーサネットの場合、必要な情報をヘッダーとトレーラーとしてつける
    - イーサネットの決まりごとに沿って、データは電気信号になり、ネットワークへと送られる
  - データを受け取った側は、この手順を逆に行う
    - 最終的にデータを受け取るアプリケーションにデータが届く

---

## 第3章　TCP/IPでコンピューターや機器を識別する仕組み

- TCP/IPの各層においてネットワークの危機がどのように識別されているか
- IPアドレス
- ポート番号
- MACアドレス

### 1　TCP/IPの各レイヤーが識別する仕組み

- ネットワークでデータをやり取りするときに、**データをやり取りする相手**を特定する必要がある
  - TCP/IPでは、各レイヤーで相手を特定するために**識別子**という仕組みを使う

|層|識別子|役割|
|:---:|:---:|:---:|
|ネットワークインタフェイス層|MACアドレス|直接データをやり取りするコンピューターや機器を特定する|
|インターネット層|IPアドレス|最終的にデータをやり取りする相手を特定する|
|トランスポート層|ポート番号|アプリケーション層を担当するソフトウェアとの間にある仮想的な通路を識別する|

- 1つのデータをやり取りするときに合計3つの識別子が使われる
- データをやり取りする相手のIPアドレスとポート番号はユーザーがアプリケーション層のソフトウェアを使用して指定する
- MACアドレスは、IPアドレスと対応させるためのプロトコル（**ARP**）を使ってコンピューターや機器が調べるのでユーザーは指定しない

### 2　トランスポート層で使われるポート番号

- **ポート**
  - アプリケーション層を担当するソフトウェアとデータのやり取りを行う仮想的な通路の出入り口
- **ポート番号**
  - データのやり取りのために作られる複数の通路を識別するために使われる
- サーバーからしたら、いつどのクライアントからデータが送られてくるのかがわからない
  - ポートをあらかじめ作っておき、クライアントからのデータを待つ
  - この状態が、**ポートを開放している**という
- クライアント側では、データのやり取りをはじめる際にポートを作成し、ポートにポート番号をつける
  - クライアント側のTCPで、データを分割してセグメントを作成するときにクライアント側のポート番号を送信元にする
  - サーバーソフトのポート番号を宛先としてヘッダーに加える
- セグメントを受け取ったサーバー側のTCPは、ヘッダーにかかれているポート番号を見て、どの通路を使ってデータを渡せばいいかを判断する
  - サーバーから要求されたデータをクライアントに送る
  - この時、クライアント側が送ってきたセグメントのヘッダー情報にあった送信元ポート番号を宛先ポート番号としてヘッダーの情報に加える
- セグメントを受け取ったクライアント側のTCPは、ヘッダー情報にある宛先ポート番号を見て、どの通路にデータを送るのかを判断する

### 3　ポート番号の種類

- **ポート番号**
  - `0 ~ 65535`

|種類|範囲|
|:---:|:---:|
|ウェルノウンポート番号|`0 ~ 1023`|
|予約済みポート番号|`1024 ~ 49151`|
|動的/プライベートポート番号|`49152 ~ 65535`|

- ウェルノウンポート番号
  - 特定の用途で使用するためにIANAが管理する
  - サーバーソフトはウェルノウンポート番号を使うのが一般的
  - |番号|用途|
    |:---:|:---:|
    |20|FTP（データ転送用）|
    |21|FTP（制御用）|
    |22|SSH|
    |23|Telnet|
    |25|SMTP（メール）|
    |53|DNS|
    |67|DHCP|
    |80|HTTP（ウェブ）|
    |110|POP3（メール）|
    |123|NTP|
    |137|NetBIOS名前解決|
    |138|NetBIOS Datagram Service|
    |139|NetBIOS|
    |443|HTTPS|
    |587|Submission（メール送信）|
- 予約済みポート番号
  - サービスやアプリケーションごとに割り当てられたポート番号
  - IANAが登録を受け付ける
- 動的/プライベートポート番号
  - 自由に使えるポート番号
  - クライアントは、この蛮夷のポート番号を使う
  - サーバーソフトのポート番号はサーバーソフトの種類に応じて決められているウェルノウンポート番号を使う

### 4　インターネット層で使われるIPアドレス

- **IPアドレス**
  - インターネット層のIPが**最終的にデータをやり取りするコンピューターや機器を特定するために使う識別子**
  - TCP/IPネットワークに参加しているコンピューターや機器には、IPアドレスが付けられる
  - クライアントには1台につき、1つのIPアドレスをつけるのが一般的
  - サーバーやネットワーク機器の場合、1台に複数のIPアドレスを付けるケースも見られる
- **データグラム**
  - IPが作るパケット
- データグラムのヘッダー
  - 送信元アドレス（自分自身のIPアドレス）と、最終的にデータをやりとりする相手の宛先IPアドレスの情報が含まれる
- **ルーティング**
  - IPは宛先のIPアドレスの情報を参照して、相手にたどり着くまで通る経路
- **割り当てる**
  - ネットワークに参加しているコンピューターや機器にIPアドレスをつけること
- **DHCP**
  - 自動的にIPアドレスを割り当てるネットワーク
  - このサービスがネットワーク内にある場合、ネットワーク管理者が設定作業を行う必要はない
- **IPv4**
  - 32ビットで8桁の2進数を4つ組み合わせたものを10進数にして表す
  - 1つのIPアドレスはネットワークを識別する**ネットワークアドレス**と、個々のコンピューターや機器を識別する**ホストアドレス**に分かれる
    - 同じネットワークに存在するコンピューターや機器のネットワークアドレス部は同じで、ホストアドレスはそれぞれ異なる

### 5　IPアドレスのクラス

- IPアドレスの**先頭から何ビットまでがネットワークアドレスなのか**によって、クラスA~Eに分けられる
  - 一般的にデータのやり取りで利用されるのはA~C
- ネットワークアドレスの範囲
  - クラスA
    - **2進数で0から始まる、先頭から8ビット**
    - `0.0.0.0 ~ 127.255.255.255`
    - 126個
      - `0.x.x.x ~ 127.x.x.x`
    - ポストアドレス
      - 約1600万個
      - 256*256*256 = 16777216
  - クラスB
    - 2進数で10から始まる、先頭から16ビット
    - `128.0.0.0 ~ 191.255.255.255`
    - 約16000個
      - `128.0.x.x ~ 191.255.x.x`
      - (191-128)*256 = 16128
    - ポストアドレス
      - 約65000個
      - 256*256 = 65536
  - クラスC
    - 2進数で110から始まる、先頭から24ビット
    - `192.0.0.0 ~ 223.255.255.255`
    - 約200万個
      - `192.0.0.x ~ 233.255.255.x`
      - (233-192)*256*256 = 2686976
    - ポストアドレス
      - 254個
- ネットワークアドレスのビット数が少ないと、表せるネットワークの数が少なくなる
  - ただ、その分ホストアドレスのビット数が増える
- 特殊なIPアドレス
  - 各ネットワークのホストアドレス部の一番最初（2進数ですべて0）は、ネットワーク全体を表す
  - 各ネットワークのホストアドレス部の一番最後（2進数ですべて1）は、**ブロードキャストアドレス**
  - この2つは、コンピューターや機器に割り当てられない
- クラスD
  - 複数の宛先にデータを送るときに使われる**マルチキャストアドレス**
  - 2進数で1110から始まる、先頭から4ビット
- クラスE
  - 実験用のアドレス
  - 2進数で11110から始まる、先頭から4ビット
- **ループバックアドレス**
  - コンピューターや機器自身を表す
  - `127.0.0.1` など

### 6　グローバルIPとプライベートIP

- **グローバルIP**
  - インターネットで通用するIPアドレス
  - インターネットに参加しているコンピューターや機器に割り当てられる
  - 重複しないように、ICANN（日本ではJPNIC）が管理している
  - 企業、個人は契約ISPからグローバルIPを貸し出してもらっている
- **プライベートIP**
  - 1つのネットワークの中だけで通用するIPアドレス
  - ネットワーク管理者が自由に割り当てられる
  - 指定できる範囲
    - クラスA
      - `10.0.0.0 ~ 10.255.255.255`
    - クラスB
      - `172.16.0.0 ~ 172.31.255.255`
    - クラスC
      - `192.168.0.0 ~ 192.168.255.255`
  - LANでは、各コンピューターや機器にプライベートIPを割り当てる
- 他のネットワークやインターネットではプライベートIPは通用しない
  - ネットワークをまたいでデータをやり取りする場合は、**ルーター**を使って、**プライベートIPとグローバルIPを変換する**
- LANの中のコンピューターや機器にグローバルIPをつけると、インターネットを介して外部の侵入者から特定され、攻撃される危険がある
  - そのため、**直接インターネットとデータをやり取りする**サーバーやネットワーク機器には**グローバルIP**を割り当てる
  - **クリアントやLANの中だけで使用する**サーバーやネットワーク機器には**プライベートIP**を割り当てる

### 7　サブネットマスクとは

- IPアドレスをクラスに分ける方法の場合、IPアドレスの数がクラスごとに決まっていて、実際のネットワーク構成に応じて数を調整できない
  - そこで、IPアドレスの全32ビットのうち、どこからどこまでがネットワークアドレスかを表す**サブネットマスク**と組み合わせて使う「**サブネッティング**」方法が生まれる
  - サブネットマスクを使うことで、**1つのネットワークを複数のネットワークに分割できる**
- **サブネットマスク**
  - IPアドレスと同様に8桁の2進数を4つ組み合わせる
  - ネットワークアドレスを1、ホストアドレスを0として、10進数で表記する
  - 仮に、サブネットマスクで、2進数で先頭から1が24個、残りが0だとする
    - 全32ビットのIPアドレスのうち先頭から24ビットがネットワークアドレスになる
    - 10進数で表記すると、 `255.255.255.0`
- サブネットマスクによって、**ホストアドレスの部分からネットワークを表す部分に変わった分**が**サブネット部**
  - **サブネッティングによって分けられたネットワーク**が**サブネット（ワーク）**
- サブネットマスクを使ったIPアドレスの例
  - 先頭から24ビット分がネットワークアドレスのクラスCのIPアドレスに対して、先頭から28ビット分がネットワークアドレスとする「255.255.255.240」のサブネットマスクを使うとする
    - `192.168.0.0 ~ 192.168.255.255` のクラスCプライベートIP
    - `255.255.255.240` のサブネット
    - `192.168.0.0` のプライベートIPと `255.255.255.240` のサブネットを2進数にする
      - `192.168.0.0`　→　`11000000.10101000.00000000.00000000`
      - `255.255.255.240`　→　`11111111.11111111.11111111.11110000`
  - ネットワークアドレスが先頭から24ビット分だったのが、サブネットマスクによって、28ビット分になる
    - サブネットマスクで1の部分は、IPアドレスの0、1をそのまま書く
      - `11000000.10101000.00000000.00000000`（プライベートIP）
      - `11111111.11111111.11111111.11110000`（サブネットマスク）
      - `11000000.10101000.00000000.0000XXXX`
      - `11000000.10101000.00000000.0000`（2進数で表せる部分がネットワークを表す部分）
      - `XXXX`（ホストアドレスとして表せる部分）（サブネット部）
  - サブネットマスクで0の部分（ホストアドレスを表すサブネット部）の桁で、表せるホストアドレスを計算する
    - `XXXX` の4桁から表せるのは16個のサブネット
      - `0000`, `0001`, `0010`, `0011`, `0100`, `0101`, `0110`, `0111`, `1000`, `1001`, `1010`, `1011`, `1100`, `1101`, `1110`, `1111`
    - ただ、`0000` と `1111` は特殊なアドレスなので、実際は14個
  - 「2進数で表せる部分がネットワークを表す部分」の末尾に、「表せるホストアドレス」の値を付けて10進数にする
    - `11000000.10101000.00000000.0000` と `1010` をつけるとする
    - `11000000.10101000.00000000.00001010` になり、10進数にすると `192.168.0.10` になる
- サブネットマスクの説明のイラスト
  - [サブネットマスク(subnet mask)とは？](https://www.cman.jp/network/term/subnet/)
- サブネットマスクの計算した結果が見れるところ
  - [サブネットマスク計算(IPv4)／サブネット一覧（早見表）](https://note.cman.jp/network/subnetmask.cgi)

### 8　VLSMとCIDR

- IPアドレスとサブネットマスクを組み合わせる方法で、**1つのネットワーク内ではすべて同じサブネットマスク**を使う
  - しかし、サブネットごとに必要なIPアドレスの数が違うこともあり、効率的ではない
- 1つのネットワークで異なるサブネットマスクを使える**VLSM（Variable Length Subnet Mask、可変長サブネットマスク）**が考え出される
  - ネットワーク構成に応じてサブネットマスクを変更し、効率よくIPアドレスが使える
- **クラスレスアドレッシング**
  - IPアドレスをクラスで分ける概念をなくして、自由にIPアドレスの数を決められる
- **CIDR（Classless Inter Domain Routing）**
  - クラスレスアドレッシングを実現するために使われる
  - **プレフィックス長**
    - 全体の32ビットのうち、先頭から何ビットがネットワークアドレスなのかを表す
    - 「/」とビット数で表す
    - `172.16.10.125/24` だと、ネットワークアドレスが先頭から24ビットを表す
- IPアドレスをクラス分けした場合は、全32ビットのうち先頭の数字を見れば、どのクラスなのかがわかる
  - IPアドレスだけでネットワークアドレスの部分がどこまでかを判断できる
- クラスレスのCIDRの場合、そこまでがネットワークアドレスの部分なのかを判断するために、IPアドレスに加えてプレフィックス長が必要になる
- JPNICでは、グローバルIPの割り当てをCIDRで行う
  - 企業や個人がISPからグローバルIPを貸し出すときも、CIDR表記でグローバルIPアドレスの範囲が指定される

### 10　ネットワークインターフェイス層で使われるMACアドレス

- **MACアドレス（Media Access Control address）**
  - ネットワークインターフェイス層のプロトコル（イーサネット）で使われる識別子
  - NIC製造時にメーカーによって付けられる
  - コンピューターやNICを買い換えるとMACアドレスも変わる
  - 全48ビットで、16進数で表記する
  - 先頭から24ビット（16進数で6桁）は、製造メーカーを表すOUI
    - **OUI（Organizationally Unique Identifier）**
    - MACアドレスを管理するIEEE組織が製造メーカーに割り当てている
  - 残りの24ビットは、製造メーカーが管理して割り当てる部分
- **NIC（Network Interface Card）**
  - イーサネットカード、ネットワークカード、LANカードとも呼ばれる
- ネットワークインターフェイス層は、**直接データをやり取りする相手との通信を担当する**
  - イーサネットがデータを分割してフレームを作成する際、**直接データをやり取りする相手のMACアドレスを宛先アドレスとして指定**する
  - コンピューターや機器を経由するたびに、経由したコンピューターや機器のMACアドレスが指定されていく

### 11　ブロードキャストでネットワーク全体に送信

- データのやり取りの仕方
  - **ユニキャスト**
    - コンピューターや機器が1対1の関係
  - **ブロードキャスト**
    - 1台のコンピューターや機器からネットワーク全体にデータを送る
    - 相手の識別子など、**データをやり取りするときに必要となる情報を取得する際に使われる**
      - 相手の識別子がわからない状態では、相手を特定してデータを送れないので、ネットワーク全体に問い合わせをする
    - ブロードキャストでデータを送るときは、ブロードキャスト専用の識別子（**ブロードキャストアドレス**）を使う
    - **リミテッドブロードキャスト**
      - 同じネットワーク全体に送る
      - IPアドレスの全32ビットが2進数で1、10進数で `255.255.255.255`
    - **ディレクティッドブロードキャスト**
      - 指定したネットワークアドレス内全体に送る
      - ネットワークアドレス部分をすべて2進数の1にしたアドレス
        - `192.168.2.0/24` というネットワークだったら、 `192.168.2.255` がブロードキャストアドレス
      - 他のネットワークから特定のネットワークへブロードキャストしたい場合
        - `192.168.2.0/24` ネットワークにブロードキャストしたいとする
        - データはいったん `192.168.2.0/24` のネットワークまで運ばれる
        - `192.168.2.0/24` に着いた時点で `192.168.2.0/24` 全体にブロードキャストされる
    - MACアドレスでは、全48ビットがすべて2進数の1、16進数で `FF:FF:FF:FF:FF:FF` がブロードキャストアドレスになる
  - **マルチキャスト**
    - 特定の複数の相手に送る

### 12　マルチキャストで特定のグループに送信

- **マルチキャスト**
  - 特定のグループに属する複数のコンピューターや機器に対してデータを送る
  - ルーティング時にも使われる
  - サーバーが送るデータは1つだけで、途中のネットワーク機器で複製されて、複数の相手に送られる
    - ユニキャストだと、複数のクライアントの分だけ同じデータを送ることになる
- **マルチキャストグループ**
  - マルチキャストの受信側が参加する
  - マルチキャストに対応しているソフトウェアで、マルチキャストグループ用として決めたIPアドレスを設定する
  - マルチキャストグループ用のIPアドレス宛にデータを送ると、マルチキャストキャストグループに参加しているすべてのコンピューターや機器にデータが届く
- **IPのマルチキャストアドレス**
  - クラスDの範囲 `224.0.0.0 ~ 239.255.255.255` を使う
  - `224.0.0.0 ~ 224.0.0.255` は特定の用途に使う
  - `224.0.1.0 ~ 238.255.255.255` はインターネットで使用されるために、IANAによって管理される
  - `239.0.0.0 ~ 239.255.255.255` は、LANの用に閉じられたローカルネットワークで自由に使う
- **マルチキャスト用のMACアドレス**
  - マルチキャスト用として設定したIPアドレスから割り出す
    - MACアドレスの全48ビットのうち、先頭から25ビット分はマルチキャスト用として決められている
    - 残りの23ビット分は、IPのマルチキャストアドレスから割り出す
  - ユニキャスト用のMACアドレスとは別に、マルチキャスト用のMACアドレスが作られる
  - マルチキャストグループが違えば設定したIPアドレスも変わるのでMACアドレスも異なる
- インターネットで使うマルチキャストアドレスの一覧
  - [IPv4 Multicast Address Space Registry](https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml)

### 13　ARPでIPアドレスに該当するMACアドレスを求める

- データをやり取りする相手のIPアドレスはユーザーが指定するが、MACアドレスは指定しない
  - しかし、MACアドレスがわからないままだとデータのやり取りができない
- **ARP（Address Resolution Protocol）**というプロトコルを使ってMACアドレスを調べる
  - ARPはインターネット層に属する
- MACアドレスを知りたい相手が同じネットワークにいる場合
  - ARPは探したいIPアドレスを持つコンピューターや機器にMACアドレスのリクエスト用のパケットを作る
  - 下位のネットワークインターフェイス層のイーサネットに渡す
  - イーサネットはパケットをフレームにして、**ブロードキャスト**で送る
  - フレームはネットワークに参加しているすべてのコンピューターや機器に届く
  - 受け取った側は、ARPのリクエストパケットを見て、自分のIPアドレスが該当するのであれば、ユニキャストで返信する
  - これで、送信側はデータをやり取りしたい相手のMACアドレスがわかる
  - ARPで知ったIPアドレスとMACアドレスの情報を**ARPテーブル**として保存しておき、今後のデータのやりたりに使う
- MACアドレスを知りたい相手が別のネットワークにいる場合
  - パケットをネットワークの出入り口（ゲートウェイ）に送る
  - ただし、ゲートウェイのMACアドレスが分からないので、ゲートウェイのIPアドレスを指定したリクエストのパケットを作る
- ARPはIPアドレスからMACアドレスを求める
  - MACアドレスからIPアドレスを求める場合は、RARP（Reverse ARP）というプロトコルを使うが、現在はあまり利用されてない

### 14　次世代のIP「IPv6」とは

- **IPv6**
  - アドレス長
    - 128ビット
      - 作成できるIPアドレスの数は2の128乗（約340澗個）
  - 表記
    - 16ビットずつ「:」で区切って16進数で表す
- **IPv4**
  - アドレス長
    - 32ビット
      - 作成できるIPアドレスの数は2の32乗（約43億個）
- IPv6アドレス
  - インターネット層の識別子
  - 基本的な働きはIPv4と同じ
  - IPv6アドレスの構造
    - **サブネットプレフィックス**
      - IPv4アドレスのネットワークアドレスに相当する
    - **インターフェイスID**
      - ホストアドレスに相当する
  - 通信相手に夜挙動の違い
    - ユニキャストアドレス
      - 1対1でやり取りするときに使用する
    - マルチキャストアドレス
      - 一度に多くの機器と通信する
    - エニーキャストアドレス
      - グループ内の1つの機器とだけやり取りする
  - アドレス数が十分確保できることから、**すべての機器にグローバルアドレスを割り振ることもできる**
    - NATでプライベートIPとグローバルIPを変換する必要もなくなる
    - パケットの暗号化機能を組み込めたり、モバイルで使用しやすいなどもある

---

## 第4章　LANで使われている技術

- ルーター
- ルーティング
- LAN内で使われるディレクトリサービス

### 1　LANとWAN

- **WAN（Wide Area Network）**
  - 離れた場所にあるLANを結んだネットワーク
  - 一般的に企業のLANとLANを結ぶものをWANと呼ぶ
  - インターネットは誰もが自由に使用できるが、WANは通信事業者と契約してはじめて使える
  - WANはどのコンピューターや機器が参加しているかを把握できる
  - WANはLANと同じ用に閉じられたネットワーク
- LANとLANの間を結ぶには、通信事業者が提供するネットワークを使用する
  - 通信事業者が提供するネットワーク
    - 回線を占有しない
      - **パケット交換方式**
        - 通信速度が速く、複数のLAN間でデータをやり取りできる
        - **IP-VPN**、**広域イーサネット**、**フレームリレー**などのサービスがある
    - 回線を占有する
      - **回線交換方式**
        - データを送りたいときに、送りたい相手を指定して回線を確保する方式
        - 支店間を結ぶ内戦電話サービスなどに向いている
      - **専用線方式**
        - 2点間を専用の回線で結び、データをやり取りする方式
        - 高速で安定したデータのやり取りができるが、コストがかかる
- **IP-VPN**
  - IPを使うIPネットワークの中に、仮想的にLANとLANを結ぶネットワークを作る技術
  - 通信事業者が専有するIP網を使用して、LANとLANを接続する
- **広域イーサネット**
  - イーサネットでLAN間を結ぶ

### 2　ゲートウェイを設置してほかのネットワークと接続する

- **ゲートウェイ**
  - ネットワークから別のネットワークへつながる出入り口
  - 役割の1つとして、**異なる仕組みを採用するネットワーク同士でデータをやり取りする**
    - インターネットとLANの間でデータのやり取りをする時、LANの中ではプライベートIP、インターネットではグローバルIPを使用する
    - 使用するIPが違うのでデータをやりとりができない
    - そこで、プライベートIPとグローバルIPの両方を持つ機器（**ゲートウェイ**）を介することで、データのやり取りが可能になる
  - ゲートウェイで複数のネットワークに参加するので、**複数のネットワークインターフェイスを備えたハードウェア**を使用する
    - **ルーター**を使うことが多いが、ネットワークインターフェイスを複数備えたコンピューターを**ゲートウェイサーバー**として使用することも可能
  - ゲートウェイは参加しているネットワークごとにIPアドレスを持っている
    - 参加しているネットワークで採用しているプロトコルが異なる場合、プロトコルも両方に対応する
- **デフォルトゲートウェイ**
  - ネットワーク内のコンピューターや機器が他のネットワークのコンピューターや機器にデータを送るときに指定したIPアドレスのゲートウェイを通るように設定する
  - 指定されたゲートウェイが**デフォルトゲートウェイ**
- **セキュリティ**
  - 他のネットワークへ送られるデータや、他のネットワークから届くデータは必ずゲートウェイを通る
  - ゲートウェイでデータをチェックし、危険なデータを排除する

### 3　データの道筋を決めるルーティング

- **ルーティング**
  - TCPのインターネット層で、IPが担う役割の1つにルーティングがある
  - **どのルートを通ってデータをやり取りすればよいのかを選択する**
    - **経路選択**
  - ルーティングを行う機器は**ルーター**
- **ルーティングテーブル**
  - どのルートを選べばよいのかを判断するために「ネットワークアドレスが特定のIPアドレス宛にデータを送る場合、このルーターに送る」という情報を集めたもの

### 4　スタティックルーティングとダイナミックルーティング

- ルーティングテーブルを作る方法
  - **スタティックルーティング**
    - ネットワーク管理者が手作業で登録する
    - ネットワークの変更時の情報を手作業で変更する必要がある
    - 障害が起きた場合、管理者が設定を変更し、復旧したら元に戻すことになる
    - ルーター自身がルーティングテーブルを作る作業を行わなくてもいいので、ルーターの負担が少なく済む
    - 小規模ネットワーク、特定の経路にルーティングすることが決まっている場合に浮かう
  - **ダイナミックルーティング**
    - ルーター同士が**ルーティングプロトコル**を使って、情報を交換してルーティングテーブルを作る
    - 初期設定時に自動的にルーティングテーブルが作られるので、管理の手間がかからない
    - 障害が起きても、別の経路を通るように情報が切り替わる
    - 他のルーターと情報を交換し、ルーティングテーブルを作成、更新するので、ルーターとネットワークに負担がかかる

### 5　ルーティングプロトコルを使ってルーター同士が通信

- ルーターがルーティングテーブルを作るために使うルーティングプロトコル
  - AS内のルーター同士が使うもの
    - IGP（Interior GateWay Protocol）
  - AS外のルーター同士が使うもの
    - EGP（Exterior GateWay Protocol）
- **AS（Autonomous System、自律システム）**
  - **インターネットを構成しているネットワークの単位**
  - 巨大なネットワークでは全体を管理することは難しいので、プロバイダや企業などを1つの簡易としてネットワークを形成し、管理する
  - この1つ１つがAS
  - どのASかを区別するため、**AS番号**が付けられる
- **AS番号**
  - グローバルAS番号
    - インターネットで通用するAS番号
    - ICANNが管理する
  - プライベートAS番号
    - グローバルAS番号を持つネットワーク内で使うAS番号で、インターネットでは通用しない
- ルーティングプロトコルのルーティングテーブルの情報の交換方法
  - ディスタンスベクター型
    - 隣接するルーター同士で情報を交換する
  - リンクステート型
    - リンクの情報をすべてのルーターに送る
  - 各ルーターは、送られてきた情報を元に、ネットワ0区全体を把握するデーターベースを作る

### 7　DHCPサービスの仕組み

- **DHCPサービス**
  - IPアドレス、デフォルトゲートウェイ、サブネットマスクなどのデータのやり取りに必要な情報を自動的に設定するネットワークサービス
  - **DHCP（Dynamic Host Configuration Protocol）**
  - TCP/IPのアプリケーション層に属するプロトコル
  - トランスポート層のプロトコルとしてUDPを使用する
- DHCPのメリット
  - 割り当てるIPアドレスの範囲を指定することで、IPアドレスの管理の手間が省ける
  - ユーザーに設定情報を配布したり、設定方法を指導したり、代行する必要がない
  - ユーザー側も設定を行わなくても良い
- DHCPサーバーと新たにネットワークに参加したクライアントとのデータの流れ
  - クライアントは、DHCPサーバーが存在したら返信をもらうように、ブロードキャストをする
    - **DHCP DISCOVER**
  - DHCPサーバーはDHCP DISCOVERの返信としてユニキャスト出クライアントにデータを送る
    - **DHCP OFFER**
  - クライアントはDHCP OFFERの中から使用するDHCPサーバーを1つ選び、使用するDHCPサーバーの情報を送ってもらうようにブロードキャストをする
    - **DHCP REQUEST**
  - DHCP REQUESTが送られたDHCPサーバーは**アドレスプール**から1つIPアドレスを選び、そのIPアドレスなど必要な情報を含んだユニキャストでクライアントに送る
    - **DHCP ACK**
  - DHCP ACKを受け取ったクライアントは、含まれた情報を設定する
- **アドレスプール**
  - クライアントに割り当てるIPアドレスの範囲
- DHCPにはIPアドレスの有効期限を設けて、期限を過ぎたら再度IPアドレスを割り当てる機能がある
  - クライアントのIPアドレスは時間経過によって変わる
  - 常に同じIPアドレスにする必要があるサーバーには、ネットワーク管理者が手作業でIPアドレスを割り当てる

### 8　ディレクトリサービスを導入する

- ディレクトリサービス
  - ネットワークに参加しているコンピューターや機器、ユーザーの情報などを集めたDBを作り、一元管理するネットワークサービス
  - ファイルサーバーなどのサーバーやプリンターをどのユーザーがどのように利用できるのかは、各サーバーソフトで1つ1つ設定して管理する
  - しかし、それぞれで管理すると手間がかかるし、変更も容易ではない
  - そこで、1つにまとめて管理するのがディレクトリーサービスの考え方
- ソフト
  - Windows Server
    - **Active Directory**
  - UNIX系OS
    - **OpenLDAP**
- ディレクトリーサービスを利用するには
  - ディレクトリーサービスを提供するサーバーを構築する
  - サーバーでユーザーやコンピューター、機器の情報を一元管理する

### 9　NATとNAPT

- プライベートIPが割り当てられているLANの中のコンピューターがインターネットに接続する場合
  - グローバルIPがないのでそのままでは利用できない
  - そこで、LANからインターネットへの出入り口となるゲートウェイで、**グローバルIPとプライベートIPを交換する**
  - **NAT**と**NAPT（IPマスカレード）**がある

### 10　VPNの仕組み

- **VPN（Virtual Private Network）**
  - 複数のユーザーが共同で使用しているネットワークの中に、仮想的にネットワークを作る仕組み
- IP-VPN
  - 通信事業者が所有するIP網を利用するVPN
  - LANとLANを結ぶ方法として利用される
- **インターネットVPN**
  - インターネットを利用するVPN
  - 外出先から社内のLANを利用するときなどに使われる
- VPNのプロトコル
  - IPSec（Security Architecture for Internet Protocol）
  - PPTP（Point-to-Point Tunneling Protocol）
  - L2TP（Layer 2 Tunneling Protocol）
- WindowsOSでは、IPSecとL2TPを組み合わせた方式（L2TP/IPSec）とPPTPを標準で装備している
- VPNのポイント
  - **暗号化**
    - VPNでは、インターネットなどの多くのユーザーが利用するネットワークを使い、閉じられたネットワークの中野コンピューターとデータをやり取りする
    - 途中でデータを盗まれたり、改ざんされる危険性がある
    - そのため、データを暗号化してやり取りする
  - **トンネリング**
    - パケットをカプセル化してやり取りする
    - OSI参照モデルのどの層のパケットをカプセル化するかによって、レイヤー2トンネリング、レイヤー3トンネリングなどと呼ぶ
  - **認証**
    - 正規のデータのやり取りであるかを認証する機能が装備されている
    - **IKE（Internet Key Exchange）**などが使われる
- VPNを利用するには
  - VPNに対応したゲートウェイを導入する
  - 外出先のコンピューターからインターネットVPNを利用する場合、VPNクライアントソフトを導入する必要がある

### 11　無線LANの仕組み

- 無線LAN
  - OSI参照モデルの物理層にケーブルを使わず、赤外線や電波を使用してデータをやり取りするLAN
- アクセスポイント
  - 有線で構築されたLANに無線LANを導入する場合に必要な機器
- 無線LANの規格
  - IEEEが策定した**IEEE 802.11**が広く普及している
  - 現在主に使われているのは、**IEEE 802.11n**、**IEEE 802.11ac**
- Wi-Fi
  - 無線LAN機器を扱うメーカーの業界団体
  - 規格名ではない
  - **Wi-Fi Alliance**を取得している機器であれば、ほかのメーカーの機器とも問題なくデータをやり取りできることが保証されている
- 無線LANのセキュリティ
  - 設定時に**WPA2-AES（WPA-AES、WPA2）**を選ぶ
  - 不正侵入を防ぐために、LAN接続を確認する技術規格「**IEEE 802.1X**」を導入して、許可されたコンピューターや機器だけが接続できるように制限する
  - 誰もが見られる無線ネットワークの識別子「**ESSID**」（**SSID**）に企業名をつけると、簡単に企業名を特定されてしまう

### 12　イーサネットはCSMA/CDでデータの衝突を防ぐ

- **CSMA/CD（Carrier Sense Multiple Access with Collision Detection）**
  - ネットワークインターフェイス層のプロトコル（イーサネット）に採用されている仕組み
  - コリジョンを起こさないようにしつつ、起きた場合にも対処する役割を持つ
  - 回線にデータが流れていないかを確認し、空いていればデータを送る
    - **Carrier Sense**
  - 1本の回線を複数のコンピューターや機器が共有して使う
    - **Multiple Access**
  - コリジョンが起こったら、それを検知してしばらく待ってから、再び回線の確認から始める
    - **Collision Detection**
- **半二重通信**
  - 1本の回線を送信と受信の両方に使う通信方式
  - 同時に送受信ができない
  - 同時に双方向からデータがやってくることがあり、データが衝突してしまう
    - **コリジョン**
- **全二重通信**
  - 複数の回線を使い、同時に送受信できる方式

---

## 第6章　ネットワークセキュリティを強固にする

### 1　ネットワークを利用するならセキュリティは必須

- 企業ネットワークのさまざまな危険
  - 機密データを盗まれる
  - 「踏み台」にされる
    - クラッカーはあるネットワークに侵入して、そこから他のネットワークを攻撃する
    - その時、最初に最初に侵入されたネットワークを**踏み台**と呼ぶ
    - 踏み台にされたネットワークから攻撃されているように見えるので、本来は被害者なのに加害者にされてしまうこともある
  - ウイルス
  - 内部からの情報漏えい
  - 不適切なネット利用によるトラブル

### 2　ファイアウォールを構築して不正侵入を防ぐ

- LANとインターネットを行き来するデータは、必ず**ゲートウェイ**を通る
  - ゲートウェイに危険なデータかどうかを判断する機能を持たせ、行き来するデータをチェックして安全と判断したデータだけを通す
  - この仕組みが**ファイアウォール**
- **アプライアンス**
  - ファイアウォールとして使用することを目的として設計された機器
  - 設定が簡単にできる
- ルーターもゲートウェイとして使用するので、ファイアウォールの機能が組み込まれている
  - 細かい設定はできない
  - 小規模のネットワークでネットワーク内にウェブサーバーなどインターネットに公開しているサーバーが存在しない場合には、ルーターのファイアウォール機能だけで済ませるケースもある

### 3　ファイアウォールの種類

- ファイアウォールの種類と、扱えるレイヤーについて
  - |TCP/IPレイヤー構造|アプリケーションレベル<br>ゲートウェイ|サーキットレベル<br>ゲートウェイ|パケットフィルタリング|
    |:---:|:---:|:---:|:---:|
    |アプリケーション層|◯|☓|☓|
    |トランスポート層|◯|◯|☓|
    |インターネット層|◯|◯|◯|
    |ネットワークインターフェイス層|◯|◯|◯|
- **アプリケーションレベルゲートウェイ**
  - ゲートウェイを通過するデータの中身までをチェックして判断する
- **サーキットレベルゲートウェイ**
  - TCPが担当するデータのやり取りの手順を監視して、通してよいデータかどうかを判断する
  - **汎用プロキシ**
  - 実際のネットワークではあまり使われていない
- **パケットフィルタリング**
  - IPが作ったデータグラムのヘッダーを見て、IPアドレスやポート番号などの情報を元に、通してよいデータかどうかを判断する
  - ネットワーク機器で行うのが一般的
  - **ステートフルパケットインスペクション**も普及している
    - トランスポート層で行われるデータのやり取りの手順を記録し、通してよいデータがどうかを判断する

### 4　DMZを構築する

- ウェブサーバーなど、インターネットからの接続を受け付けるサーバーを構築する場合、ファイアウォールでは危険なデータの遮断ができない
  - インターネットからの接続をすべて許可すると、クライアントやサーバーに対して接続を試みる不正データの侵入も許してしまう
  - そこで、インターネットかたの接続を受け付けるサーバーと、受け付ける必要のないコンピューターを別々のネットワークに分ける
- **DMZ（DeMilitarized Zone）**
  - インターネットからの接続を受け付けるネットワーク
  - DMZ内のサーバーに不正侵入されたとしても、DMZとクライアントが属する内部ネットワークとはファイアウォールで隔てられているので、被害をDMZ内で食い止められる
- DMZには、ウェブサーバー、メールサーバー、DNSサーバーなど、**インターネットからの接続を受け付ける必要があるサーバーだけを設置する**
  - ウェブサーバーとDBサーバーを連携させるウェブアプリを稼働する場合
    - DBサーバーはDMZではなく、内部のネットワークに設置する
    - ファイアウォールでウェブサーバーから内部のDBサーバーへの接続だけをピンポイントで許可する
- DMZを作るには、3つのネットワークインターフェイスを備えるハードウェアをファイアウォールとして使う
  - インターネットからDMZ内のサーバーに接続するデータはDMZへ送る
  - それ以外のデータは危険データとして判断するよう設定する
- ファイアウォールを2つ配置して、ファイアウォール同士の間にDMZを設ける方法もある

### 5　IDSとIPSの仕組み

- HTTPリクエストが短時間に大量に送られてくる場合
  - ウェブサーバーは処理しきれず、停止する
  - サーバーを攻撃する手口として知られている**DDos攻撃**
- **データそのものには不審な点がなくても、ネットワークに被害を与える攻撃方法がある**
  - データをチェックして、安全かどうかを判断するファイアウォールだけでは防げない
- データの動きを監視して危険と思われるデータを発見するシステム
  - **IDS（Intrusion Detection System、侵入検知システム）**
    - 検知したら、ネットワーク管理者にメールなどで通知する
    - IDS自体にデータを遮断したり、対策をとることはない
  - **IPS（Intrusion Protection System、侵入防御システム）**
    - 通知だけでなく、データの遮断など遮断の対策も自動的に行う
- IDS、IPSが危険と思われるデータかどうかを判断する方法
  - よくある攻撃手口を登録しておき、同じふるまいをするデータを検知する方法
  - 「普通の状態」の範囲を登録しておき、それを超えたら異常だと判断する方法
- IDSの種類
  - **ネットワーク型IDS（NIDS）**
    - ネットワークに流れるデータを監視する
    - アプライアンスを利用するのが一般的
  - **ホスト型IDS（HIDS）**
    - サーバーに導入してサーバーが受け取るデータやサーバーOSの通信ログなどを監視する

### 6　ウイルスとは

- ウイルス
  - 悪意のあるプログラム
  - 特徴
    - 他のファイルに取り付く
    - 自己増殖する
    - 自動的に実行される
  - 代表的な種類
    - ワーム
      - 単独のファイルとして存在する
      - 自己増殖する
    - トロイの木馬
      - 便利なプログラムに見せかけて、実は悪さをするプログラム
    - マクロウイルス
      - マクロ機能を悪用するウイルス
    - ボット
      - コンピューターを乗っ取るウイルス
      - 複数のボットが連携すると、ボットネットになる
    - など
  - 不正なソフトウェアを総称として**マルウェア**と呼ぶ
- 必ずウイルス対策ソフトを導入する

### 7　ウイルス対策システムを導入する

- ウイルス対策ソフト
  - ゲートウェイ型
    - ゲートウェイでウイルスチェック
    - ウイルスがネットワーク内のコンピューターに到達する前に、出入り口でシャットアウトできる
  - サーバー型
    - クライアントにデータがダウンロードされる前にウイルスの有無をチェックできる
    - ウイルス対策ソフトを導入したサーバーで扱っているデータしかチェックしていない
  - クライアント型
    - 記録媒体で持ち込まれるウイルスもチェックできる
    - ウイルス対策ソフトの管理をユーザーする必要がある
    - 企業向けに、ネットワーク管理者が各クライアントのウイルス対策ソフトを集中管理できる製品が用意されている

### 8　コンテンツフィルタリングとは

- **コンテンツフィルタリング**
  - アプリケーションレベルゲートウェイでデータの中身を見て不適切なデータを遮断する
  - ネットワークを通ったデータは基本的に何でもチェックできる
    - 送受信するメールの内容
    - 閲覧したウェブページのURLや内容
    - 社内のクライアントからネットの掲示板やブログに投稿した内容
    - など
  - 暗号化技術を使えば、データの中身まではわからないけど、暗号化技術を使用していることはわかる
  - 各クライアントのネット使用状況をチェックする機能もあり、極端にウェブサイト閲覧時間が長いクライアントもわかる
- **セキュリティポリシー**
  - コンテンツフィルタリングを導入する際、何が不適切とするかを定める
  - 社員全体にコンテンツフィルタリングを行うこと、どのようなものをチェックしているのかなどを伝える
  - **こっそりインターネットの使用状況を監視するのがコンテンツフィルタリングの目的ではない**

### 10　社内からの書込は相手に簡単にわかってしまう

- クライアントからインターネットの掲示板に文章を投稿したとする
  - 感覚的には、一方的に文字データを掲示板に送っているように思える
  - 実際は、**クライアントとサーバーの間でデータをやり取りしている**
  - **サーバーにはクライアントのグローバルIPがわかっている**
- サーバー管理者がゲートウェイのグローバルIPをもとに、**whois**で検索すると、企業や団体名がすぐわかる

### 11　ウェブサービスで使われる暗号化技術「SSL/TLS」

- インターネットでやり取りされるデータは、誰でも内容を見られる状態で流れている
  - データを盗み見たりデータを改ざんされる危険性がある
- **暗号化技術**
  - IDやパスワード、個人情報などの盗み見られては困るデータをやり取りする際に使う
  - **データの暗号化**
  - **認証**
    - なりすましの防止
  - **改ざんの検出**
- **SSL/TLS（Secure Socket Layer/Transport Layer Security）**
  - TCP/IPのアプリケーション層とトランスポート層の間に位置する
  - HTTP、SMTP、POPなどのプロトコルと組み合わせて暗号化できる
  - データをやり取りする相手が本物かどうかを認証する方法
    - SSL/TLSサーバー証明書を使う
- **ハッシュ**
  - 改ざん検出時に使う
  - 送信側は、データを元にハッシュ値を計算し、データと一緒に送る
  - 受信側は届いたハッシュ値が同じならデータも同じで、改ざんされていないと判断する

---

## 第7章　ネットワークの構築と管理

- ネットワークを構築するにあたっての基本知識や管理、運用
- 基礎となる構成の発案
- 実際の構築
- その後の運用

### 1　ネットワーク構成を考える

- 決めること
  - **ネットワークで何をするか**
  - **どんなネットワークにしたいか**
- ネットワークを構築して何をするのか
  - 1つ1つ書き出す
  - もっと詳しく書ける項目があれば、それも書き出す
- どんなネットワークにしたいか
  - 要望を書き出す
  - ネットワーク構成に盛り込む項目、コストなどに余裕があれば行う項目に分けて優先順位をつける
- ネットワーク管理者、管理部門、ネットワーク利用者に意見を聞く
  - 管理側だけでは気づかない改善点が見つかる可能性がある

### 2　ネットワーク構成図を描く

- **ネットワーク構成図**
  - 図にすることで、具体的なイメージがわく
  - MSソフトの**Visio**とか表計算ソフトなどで描く
- **ネットワークのグループ分けから始める**
  - 1つのネットワークを、複数の小さなグループに分割する
  - グループは小さなネットワークになる
  - グループ分けする時の基準を決めて、同じものをまとめていく
    - 「利用できるサーバーや機器」、「インターネットからの接続を受け入れるかどうか」など
- **論理構成図**
  - ネットワークとしてどのような構成になっているのかを表す図
- **物理構成図**
  - 実際の配線や機器の設置場所を記した図

### 5　ネットワークを小さなネットワークに分割する

- 1つのネットワークをふうくすうの小さなネットワークに分割する
- ネットワーク構成図を描く際に分けたグループが小さなネットワークになる
  - グループの数だけ小さなネットワークが必要
- 小さなネットワークに分割することのメリット
  - 管理がしやすくなる
  - ネットワークの負荷を軽減できる
- 1つのネットワークを分割する方法
  - **サブネッティング**と**VLAN**
  - **サブネッティング**
    - サブネットマスクを使ってネットワークアドレスを表す部分を増やし、小さなネットワーク（サブネット）を作る
    - サブネットマスクは、必要なサブネット数から割り出す
    - LANの場合、プライベートIPを使うので、すべて同じサブネットマスクの値にしてわかりやすくするのが一般的
  - **VLAN**
    - LANの中で仮想的に小さいLANを作るもの
    - 物理的に離れた場所にあるコンピューターや機器を1つのVLANにすることもできる
    - VLAN機能を備えたスイッチやルーターで設定するだけで完成するが、これだけでは他のネットワークとのデータのやり取りができない
      - VLANごとに異なるネットワークアドレスを持つIPアドレス範囲を割り当てて別々のネットワークとして区別し、ルーターで他のネットワークに接続する

### 6　インターネットに接続する

- 企業ネットワークをインターネットに接続するには、法人向けのインターネット接続サービスを利用する
- 回線事業者やISPと契約して、**回線設備**と**グローバルIP**を用意する
  - ほかにもインターネット接続用のDNSサーバー、AS番号が必要
  - インターネット接続用のDNSサーバーは企業ネットワーク内に構築するのが一般的
  - AS番号は、ISPが取得しているAS番号を使うので、割り当ててもらう必要はない
- 利用する回線
  - ADSL、FTTH、専用線など
  - LANとLANをつないで、WANを作る場合
    - IP-VPNや広域イーサネット、専用線などを利用する
- 社内にウェブサーバーなどのインターネットに公開するサーバーを設置する場合
  - 社外からのアクセスが可能になるよう、常に同じグローバルIPアドレスを使用する**固定IP**サービスを利用する
  - ISPによって、オプションとして固定IPを提供するところや、法人向けでも固定IPとそうでないサービスを別々のコース名称で提供しているところがある
- **固定IP**サービスで割り当てられるグローバルIPの数
  - 1、8、16、32…という単位で契約する
  - ウェブサーバー、メールサーバー、DNSサーバを公開する場合は、8個で契約することが多い

### 8　冗長化とは

- **冗長化**
  - 障害が起きたときのために呼びを用意しておくこと
  - サーバーに障害が起きたことを考えて同じサーバーを複数台用意する
  - 冗長化の対象に応じて、**ネットワークの冗長化、ストレージの冗長化**がある
- **サーバーの冗長化**
  - 1台に障害が起きても残りのサーバーがネットワークサービスを提供する
- **ストレージ**
  - ハードディスクに代表されるデータ記録装置
  - 複数台のハードディスクを1台のハードディスクのように使える**RAID**技術を使い、同じデータを複数のハードディスクに保存しておく方法がある
- **一方に障害が起きても、もう一方が正常に動作することを考えて用意する**
  - 単に同じものを2つ用意するのではない
  - インターネット回線を2回線確保して冗長化することで、ISPのネットワークに障害が起きても、もう一方が使えるようにする
  - 電気トラブルで障害が起きることを考えて、予備は物理的に別の場所に設置する
