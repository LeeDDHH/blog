# 図解　ネットワーク　仕事で使える基本の知識［改訂新版］

- これまで気にしていなかったデータの流れを意識すれば、そんなに難しくない
- 複雑に見えても、実は非常に合理的
- ネットワーク、サーバーの構築、管理をしていく上で、知っておきたいネットワーク全体の知識をひととおりまとめる
- ネットワークには多くのサーバーやネットワーク機器が参加している
  - それぞれが役割を分担してデータを運んでいるので、1 つの技術を理解するために、ネットワークの基礎知識を持っていることが大切

## 第 1 章　ネットワークの基礎知識

- プロトコルの概念と仕組み
- LAN とインターネットの違い
- ネットワークの形態
- ネットワークへの接続
- サーバーとは何か

### 1 　ネットワークの学習は難しい？

- ネットワークを使う側から**提供する管理者の視点**に切り替える
- データの中身ではなく、**データのやり取りの流れを意識する**
  - 「ネットワークにつながっている」状態は、ネットワークを通じてデータをやり取りできる状態にあること
- 各技術や仕組みは**データのやり取りをするためにある**ことを意識する
  - ネットワークの技術や仕組みは、効率よく相手とデータをやり取りすることを最終目的として考え出されている
  - データをやり取りすることが目的

### 2 　プロトコルはフォーマットとプロシージャで構成される

- **プロトコル**
  - ネットワークに参加しているコンピューターや機器がデータのやり取りを行うための決まりごと
  - 同じプロトコルに対応していれば、データのやり取りができる
  - 複数のプロトコルをひとまとめにして、**プロトコル群**とも呼ぶ
- プロトコルの構成
  - **フォーマット**
    - 情報構造
    - **データの構成**に関する決まりごと
    - 必要な情報の表記方法や情報のある場所など、やり取りするデータがどのような構成になっているか
  - **プロシージャ**
    - 通信手順
    - **データをやり取りするときの手順**に関する決まりごと
    - データのやり取りを始めるとき、終了する時、エラーが起きたときなどにどうするのか

### 3 　プロトコルはレイヤー構造をとる

- レイヤー構造、階層構造
- レイヤーごとのプロトコルに沿って順場に処理する
- それぞれのレイヤーに役割があり、具体的な作業方法、プロトコルの詳細は異なっても役割は同じ
- あるレイヤーのプロトコルを別のものに変えても、他のレイヤーは影響を受けずそのまま使える

### 4 　 LAN とインターネットの違い

- LAN（Local Area Network）
  - 同じ建物や敷地内にあるネットワーク
  - 企業ネットワーク、家庭内ネットワーク
  - 規模にかかわらず、**ネットワーク全体を管理できる**
  - 外部から許可なく勝手に接続することはできない
  - **閉ざされたネットワーク**
- インターネット
  - 複数のコンピューターが役割を分担して全体が機能する分散型ネットワーク
  - **開かれたネットワーク**
  - インターネットの一部分を管理する企業、団体はいるが、全体を把握する管理者はいない
- LAN をインターネットに接続し、**LAN の中にコンピューターからインターネットを利用できるようにするのが一般的**
- LAN とインターネットの大きな違い
  - **全体を把握できるかどうか**

### 6 　サーバーはネットワークサービスを提供する

- サーバー
  - クライアントにネットワークサービスを提供する
  - 提供するネットワークサービスの名前に「サーバー」を付けて呼ぶ
- サーバーの構成
  - **ハードウェア**
  - **サーバー用の OS**
  - **ネットワークサービスを提供するためのソフトウェア**
- **アプライアンス**
  - サーバーとして使用するために設計された専用のハードウェア
- サーバーはコンピューターでなくても、プリンターやネットワーク機器に組み込まれているケースも見られる

### 7 　インターネットに接続するには

- 全体を管理していないインターネットに接続するにはどうしたらいいのか
  - 個々のコンピューターや機器を特定するために使われる**グローバル IP**を取得する
  - インターネットを形成する個々のネットワークを識別する**AS 番号**も必要
  - 回線設備が必要
  - ケーブルの敷設、通信に必要な装備の設置
  - グローバル IP とドメイン名を対応させる DNS サーバー（降るサービスリゾルバー）
- しかし、小規模のネットワークを使う企業や個人の場合、必要な物を提供する**回線事業者**や**ISP**と契約することになる
- **グローバル IP**
  - インターネットで使われる住所みたいなもの
- **ICANN**
  - グローバル IP と AS 番号を管理する組織
  - 各国から ICANN の委託をうけて管理する
- **JPNIC**
  - 日本で管理業務をするところ

### 9 　 FTTH の仕組み

- **FTTH**（Fiber To The Home）
  - 光ファイバーを家庭に敷設し、高速で安定したデータ通信を実現する意味
  - 現在では、企業向けを含めた光ファイバー通信サービスの総称
  - インターネット接続に加え、電話、マルチメディア配信などのサービスも合わせて提供する
  - デジタルの電気信号とデジタルの光信号を相互に変換する
- **ADSL**
  - デジタル電気信号とアナログ電気信号を相互に変換する
- ユーザーのコンピューターから送られたデータは、ユーザー宅から光ファイバーを通じて FTTH サービス事業者の収容局に送る
  - さらに、ISP のネットワークからインターネットへ送られる
- ユーザー宅と収容局を結ぶ光ファイバーのつなげ方で以下のように分ける
  - **PON**（Passive Optical Network）
    - 複数のユーザーで共有する方式
    - コストの負担が少なく、家庭用の FTTH サービスで採用される
  - **SS**（Single Star）
    - ユーザーが専有する方式
    - 企業向け
- FTTH を利用するユーザー宅には、電気信号と光信号を変換する装置を設置する
  - **メディアコンバーター**
    - SS 方式で使われる
  - **ONU**（Optical Network Unit）
    - PON 方式で使われる
- 収容局にもメディアコンバーターが設置されて、電気信号と光信号を変換する
- 最近では、家庭向けの FTTH サービスも普及しつつある

[光ファイバーが速い理由とその仕組み・構造・材質について楠リカがやさしく解説](https://simpc.jp/rikatech/about-optical-fiber/)

---

## 第 2 章　 TCP/IP を知る

- ネットワーク通信の基本的な仕組み
- ネットワークアーキテクチャーを理解し、ネットワークでどのようにデータが扱われ、流れていくか

### 1 　ネットワークアーキテクチャーと OSI 参照モデル

- ISO（国際標準化機構）が定めた OSI 参照モデル
  - データをやり取りするときに必要な決まりごと（プロトコル）を第 1~7 層までのレイヤー構造で体系的にまとめる

|   層   | レイヤー |         名前         |                                                                                                  役割                                                                                                  |
| :----: | :------: | :------------------: | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| 上位層 |   7 層   |  アプリケーション層  |                                                                     **アプリケーションがどのようにデータを処理するか**の決まりごと                                                                     |
| 上位層 |   6 層   | プレゼンテーション層 |                                                         **データの通信に適した形式やアプリケーションが処理する形式に変換する**ための決まりごと                                                         |
| 上位層 |   5 層   |     セッション層     | **通信プログラムがデータをやり取りをはじめてから終わるまでの一連の流れ（セッション）**に関する決まりごと<br>データをやり取りする相手との間に仮想的な経路を作り、データのやり取りが終われば通路を閉じる |
| 下位層 |   4 層   |   トランスポート層   |                                                         **データを確実にやり取りする**ための決まりごと<br>データ圧縮、エラー制御、再送機能など                                                         |
| 下位層 |   3 層   |    ネットワーク層    |                                                 **データをやり取りする道筋（経路選択）**の決まりごと<br>最終的にデータをやり取りする相手との決まりごと                                                 |
| 下位層 |   2 層   |    データリンク層    |                                           **同じネットワーク内でのデータのやり取り**に関する決まりごと<br>ネットワークに直接つながっている相手との決まりごと                                           |
| 下位層 |   1 層   |        物理層        |                                         ケーブルの規格、電気信号の条件などの**物理的/電気的**な決まりごと<br>やり取りされるデータは電気的な信号として扱われる                                          |

### 2 　回線交換方式とパケット交換方式

- 回線交換方式
  - 回線を専有して通信を行う
  - 大量のデータをやり取りできる
  - データのやり取りが終わるまで、他のユーザーはその回線を使用できない
- パケット交換方式
  - データをパケット単位に分けて送る
  - 回線の途中でいったん蓄積され、回線が空いているときに送る
  - リアルタイムでの通信には不向き
  - 複数のユーザーが同時に回線を使用できるので効率がいい
- パケット交換方式のデータの流れ
  - 分割したデータの先頭にやり取りで必要な情報（**ヘッダー**）をつけて、パケットを作る
  - 1 つのパケットは、**データ本体**と**ヘッダー**がセットになる
  - 末尾にトレーラーをつけることもある
  - 受信側はパケットに付いているヘッダーやトレーラー情報をもとに各レイヤーがパケットを結合してデータに戻す
  - 復元され t あデータは次に処理されるレイヤーに渡され、送信側と逆の順番で処理作業が進む

### 3 　ネットワーク標準のプロトコル「TCP/IP」

- **TCP/IP**
  - プロトコルを体系的にまとめ、どのようにネットワークを構成するかという基本概念を表したネットワークアーキテクチャーの 1 つ
- **TCP/IP プロトコル群**
  - アプリケーション層
  - トランスポート層
  - インターネット層
  - ネットワークインタフェイス層
- TCP/IP ネットワークでデータをやり取りするとき
  - ネットワークサービス用のソフトウェアと**TCP/IP プロトコルスタック**がデータを処理する
- プロトコルスタック
  - プロトコルで決めている処理を実際に行うためのプログラム群

### 4 　ネットワークインターフェイス層の役割

- **ネットワークインターフェイス層**
  - ケーブルや端子の形状、信号の形式など、物理的な決まりごとを定める
  - OSI 参照モデルでの**物理層**と**データリンク層**を担当する
- 実際に処理を行うのは、TCP/IP プロトコルスタックとプロトコルに対応したハードウェア
  - TCP/IP プロトコルスタックは、コンピューターや機器間のデータのやり取りに関する決まりごとの処理を行う
- ネットワークインターフェイス層の代表的なプロトコル
  - **イーサネット（Ethernet）**、**PPP**など
- イーサネット
  - 複数のコンピューターや機器が、1 つの回線を効率よく使用できる
  - **規格**
    - 物理的な決まりごとのほう
  - **イーサネットプロトコル**
    - データの処理に関する決まりごと
- PPP
  - コンピューターや機器が 1 対 1 の関係で接続されている回線で、データをやり取りするためのプロトコル
  - パスワード認証機能がある
  - 最近はあまり使われてない
  - インターネット接続サービスで正規の会員を認証するときに便利
- PPPoE（PPP over Ethernet）
  - PPP とイーサネットの組み合わせ

### 5 　インターネット層の役割

- **インターネット層**
  - 最終的にデータをやり取りする相手との通信に関する決まりごとを定める
  - OSI 参照モデルの**ネットワーク層**を担当する
- **IP**
  - トランスポート層の TCP/IP プロトコル群の基盤となるプロトコル
- 最終的にデータをやり取りする相手とデータをやり取りするために必要なこと
  - **どのコンピューターや機器が、最終的にデータをやり取りする相手なのか**を指定する
- **IP アドレス**
  - ネットワークの世界の住所のようなもの
  - ネットワークに参加しているすべてのコンピューわーや機器につけることで、データをやり取りする相手の指定ができる
- **経路選択**、**ルーティング**
  - **どのルートを通って行けばたどり着けるのか**を決める
- IP の主な役割は、IP アドレスの管理と経路選択
- インターネット層のプロトコル
  - IP
  - ARP
    - IP アドレスから対応する MAC アドレスを調べる役割
  - RARP
    - MAC アドレスから対応する IP アドレスを調べる
  - ICMP
    - IP が担当するデータのやり取りにおいて、エラーが発生した場合に対処するプロトコル
    - ping コマンドで使われる
  - など

### 6 　トランスポート層の役割

- **トランスポート層**
  - データのやり取りを制御するプロトコル
  - OSI 参照モデルの**トランスポート層**と**セッション層の一部**を担当する
- 通信プログラムがデータのやり取りをはじめてから終了するまでの一連の流れ（セッション）を行う仮想的な通路を作る
  - 仮想的な通路は、**同時に複数作ることができる**ので、**どの仮想的な通路で扱うデータなのかを区別する**必要がある
- **ポート番号**
  - 各通信プログラムに識別子として使う
- TCP には、さらに確実にデータを届けるための機能がある
  - **確認応答**
    - データを受信した側が、送信側にデータを受け取ったと知らせる機能
    - 送信側は、受信側からの知らせを受け取ったら、次のデータを送る
  - **再送**
    - 一定期間待っても確認応答がない場合に、再度同じデータを送る機能
  - **シーケンス番号**
    - どこまでのデータが届いたのかがわかるようにつける番号
- 一般的なデータのやり取りでは、確実に届く TCP を使用する
- 動画配信など、転送速度を重視するネットワークサービスでは UDP を使用する

### 7 　 TCP の通信手順

- TCP を使ったデータのやり取り
  - SYN
    - データをやり取りするリクエストを送るセグメント
  - ACK
    - 応答確認のセグメント
- 3 ウェイハンドシェイク
  - 送信側（SYN）
  - 受信側（ACK、SYN）
  - 送信側（ACK）
  - 送信/受信側のそれぞれが、セグメントにつけるシーケンス番号の初期値の情報をやり取りする
- データのやり取り時にセグメントを 1 つ送るたびに ACK を送ると効率が悪い
  - なので、複数のセグメントをまとめてやり取りする
  - ただ、一度に受け取れるデータ量には限度があるので、受信側は ACK のヘッダーへ**一度に受け取れるデータ量**を記載する
  - 一度に受け取れるデータ量は**ウィンドウサイズ**と呼ぶ
- ACK を受け取った送信側は、送るセグメントがシーケンス番号の何番からはじまるかをヘッダーに記載して送る
  - 受信側は何万まで受け取ったかの用法を記載し、ACK を送る
  - 一定時間待っても受信側から ACK が届かなかったら再送する
- セグメントのヘッダーには、送ったセグメントと受け取ったセグメントが同じなのかどうかを検証するための**チェックサム**を含める
  - チェックサムが一致しなかったら、途中で破損したかのうせいがあるので、再送してもらう
- データのやり取りを終了するときは、送信側が**FIN**セグメントを送る
  - 受信側は送信側に ACK を返し、その後 FIN を送る
  - 送信側は ACK を送ってデータのやり取りを終了する

### 8 　アプリケーション層の役割

- **アプリケーション層**
  - ユーザーにネットワークサービスを提供する
  - ユーザーが作成したデータをアプリケーション層のプロトコルのに沿って整えて、下位のトランスポート層に渡す
  - ユーザーと TCP/IP の橋渡しをしているレイヤー
  - OSI 参照モデルの**セッション層**、**プレゼンテーション層**、**アプリケーション層**に相当する
- データのやり取りを行う場合、利用するサービスのプロトコルに対応する必要がある
- **ヘッダー**
  - ユーザーが入力したデータに、受け取る相手のアプリケーション層のプロトコルが正しく処理するのに必要な情報

### 9 　 TCP/IP ネットワークでの各レイヤーの働き

- 上位のレイヤーから渡されたデータはカプセル化される
- TCP/IP の各レイヤーがイーサネットを使ったネットワークでデータをやり取りするときの流れ
  - アプリケーション層
    - 使うサービスのソフトで対応した決まりごとに沿って必要な情報を**ヘッダー**としてつけて、**TCP/IP プロトコルスタック**に渡す
  - トランスポート層
    - トランスポート層のプロトコルに沿って処理をする
    - データを分割して、受信側の TCP が処理を行うときに必要な情報をヘッダーとして付けて、**セグメント**を作る
    - 下位の OSI 参照モデルの**トランスポート層**と**セッション層の一部**を担当するの処理に移る
  - インターネット層
    - インターネット層のプロトコル（IP）に沿ってデータを処理する
    - 必要な情報をヘッダーとして付けて、データグラムを作る
    - 下位のネットワークインターフェイス層の処理に移る
  - **カプセル化**
    - 上位の層から受け取ったパケットをひとかたまりのデータとして扱うこと
  - ネットワークインタフェイス層
    - 受け取ったデータグラムをカプセル化し、ネットワークインタフェイス層のプロトコル（イーサネット）に沿って処理する
    - イーサネットの場合、必要な情報をヘッダーとトレーラーとしてつける
    - イーサネットの決まりごとに沿って、データは電気信号になり、ネットワークへと送られる
  - データを受け取った側は、この手順を逆に行う
    - 最終的にデータを受け取るアプリケーションにデータが届く

---

## 第 3 章　 TCP/IP でコンピューターや機器を識別する仕組み

- TCP/IP の各層においてネットワークの危機がどのように識別されているか
- IP アドレス
- ポート番号
- MAC アドレス

### 1 　 TCP/IP の各レイヤーが識別する仕組み

- ネットワークでデータをやり取りするときに、**データをやり取りする相手**を特定する必要がある
  - TCP/IP では、各レイヤーで相手を特定するために**識別子**という仕組みを使う

|              層              |    識別子    |                                    役割                                    |
| :--------------------------: | :----------: | :------------------------------------------------------------------------: |
| ネットワークインタフェイス層 | MAC アドレス |           直接データをやり取りするコンピューターや機器を特定する           |
|       インターネット層       | IP アドレス  |                 最終的にデータをやり取りする相手を特定する                 |
|       トランスポート層       |  ポート番号  | アプリケーション層を担当するソフトウェアとの間にある仮想的な通路を識別する |

- 1 つのデータをやり取りするときに合計 3 つの識別子が使われる
- データをやり取りする相手の IP アドレスとポート番号はユーザーがアプリケーション層のソフトウェアを使用して指定する
- MAC アドレスは、IP アドレスと対応させるためのプロトコル（**ARP**）を使ってコンピューターや機器が調べるのでユーザーは指定しない

### 2 　トランスポート層で使われるポート番号

- **ポート**
  - アプリケーション層を担当するソフトウェアとデータのやり取りを行う仮想的な通路の出入り口
- **ポート番号**
  - データのやり取りのために作られる複数の通路を識別するために使われる
- サーバーからしたら、いつどのクライアントからデータが送られてくるのかがわからない
  - ポートをあらかじめ作っておき、クライアントからのデータを待つ
  - この状態が、**ポートを開放している**という
- クライアント側では、データのやり取りをはじめる際にポートを作成し、ポートにポート番号をつける
  - クライアント側の TCP で、データを分割してセグメントを作成するときにクライアント側のポート番号を送信元にする
  - サーバーソフトのポート番号を宛先としてヘッダーに加える
- セグメントを受け取ったサーバー側の TCP は、ヘッダーにかかれているポート番号を見て、どの通路を使ってデータを渡せばいいかを判断する
  - サーバーから要求されたデータをクライアントに送る
  - この時、クライアント側が送ってきたセグメントのヘッダー情報にあった送信元ポート番号を宛先ポート番号としてヘッダーの情報に加える
- セグメントを受け取ったクライアント側の TCP は、ヘッダー情報にある宛先ポート番号を見て、どの通路にデータを送るのかを判断する

### 3 　ポート番号の種類

- **ポート番号**
  - `0 ~ 65535`

|            種類             |      範囲       |
| :-------------------------: | :-------------: |
|   ウェルノウンポート番号    |   `0 ~ 1023`    |
|     予約済みポート番号      | `1024 ~ 49151`  |
| 動的/プライベートポート番号 | `49152 ~ 65535` |

- ウェルノウンポート番号
  - 特定の用途で使用するために IANA が管理する
  - サーバーソフトはウェルノウンポート番号を使うのが一般的
  - | 番号 |           用途           |
    | :--: | :----------------------: |
    |  20  |   FTP（データ転送用）    |
    |  21  |      FTP（制御用）       |
    |  22  |           SSH            |
    |  23  |          Telnet          |
    |  25  |      SMTP（メール）      |
    |  53  |           DNS            |
    |  67  |           DHCP           |
    |  80  |      HTTP（ウェブ）      |
    | 110  |      POP3（メール）      |
    | 123  |           NTP            |
    | 137  |     NetBIOS 名前解決     |
    | 138  | NetBIOS Datagram Service |
    | 139  |         NetBIOS          |
    | 443  |          HTTPS           |
    | 587  | Submission（メール送信） |
- 予約済みポート番号
  - サービスやアプリケーションごとに割り当てられたポート番号
  - IANA が登録を受け付ける
- 動的/プライベートポート番号
  - 自由に使えるポート番号
  - クライアントは、この蛮夷のポート番号を使う
  - サーバーソフトのポート番号はサーバーソフトの種類に応じて決められているウェルノウンポート番号を使う

### 4 　インターネット層で使われる IP アドレス

- **IP アドレス**
  - インターネット層の IP が**最終的にデータをやり取りするコンピューターや機器を特定するために使う識別子**
  - TCP/IP ネットワークに参加しているコンピューターや機器には、IP アドレスが付けられる
  - クライアントには 1 台につき、1 つの IP アドレスをつけるのが一般的
  - サーバーやネットワーク機器の場合、1 台に複数の IP アドレスを付けるケースも見られる
- **データグラム**
  - IP が作るパケット
- データグラムのヘッダー
  - 送信元アドレス（自分自身の IP アドレス）と、最終的にデータをやりとりする相手の宛先 IP アドレスの情報が含まれる
- **ルーティング**
  - IP は宛先の IP アドレスの情報を参照して、相手にたどり着くまで通る経路
- **割り当てる**
  - ネットワークに参加しているコンピューターや機器に IP アドレスをつけること
- **DHCP**
  - 自動的に IP アドレスを割り当てるネットワーク
  - このサービスがネットワーク内にある場合、ネットワーク管理者が設定作業を行う必要はない
- **IPv4**
  - 32 ビットで 8 桁の 2 進数を 4 つ組み合わせたものを 10 進数にして表す
  - 1 つの IP アドレスはネットワークを識別する**ネットワークアドレス**と、個々のコンピューターや機器を識別する**ホストアドレス**に分かれる
    - 同じネットワークに存在するコンピューターや機器のネットワークアドレス部は同じで、ホストアドレスはそれぞれ異なる

### 5 　 IP アドレスのクラス

- IP アドレスの**先頭から何ビットまでがネットワークアドレスなのか**によって、クラス A~E に分けられる
  - 一般的にデータのやり取りで利用されるのは A~C
- ネットワークアドレスの範囲
  - クラス A
    - **2 進数で 0 から始まる、先頭から 8 ビット**
    - `0.0.0.0 ~ 127.255.255.255`
    - 126 個
      - `0.x.x.x ~ 127.x.x.x`
    - ポストアドレス
      - 約 1600 万個
      - 256*256*256 = 16777216
  - クラス B
    - 2 進数で 10 から始まる、先頭から 16 ビット
    - `128.0.0.0 ~ 191.255.255.255`
    - 約 16000 個
      - `128.0.x.x ~ 191.255.x.x`
      - (191-128)\*256 = 16128
    - ポストアドレス
      - 約 65000 個
      - 256\*256 = 65536
  - クラス C
    - 2 進数で 110 から始まる、先頭から 24 ビット
    - `192.0.0.0 ~ 223.255.255.255`
    - 約 200 万個
      - `192.0.0.x ~ 233.255.255.x`
      - (233-192)*256*256 = 2686976
    - ポストアドレス
      - 254 個
- ネットワークアドレスのビット数が少ないと、表せるネットワークの数が少なくなる
  - ただ、その分ホストアドレスのビット数が増える
- 特殊な IP アドレス
  - 各ネットワークのホストアドレス部の一番最初（2 進数ですべて 0）は、ネットワーク全体を表す
  - 各ネットワークのホストアドレス部の一番最後（2 進数ですべて 1）は、**ブロードキャストアドレス**
  - この 2 つは、コンピューターや機器に割り当てられない
- クラス D
  - 複数の宛先にデータを送るときに使われる**マルチキャストアドレス**
  - 2 進数で 1110 から始まる、先頭から 4 ビット
- クラス E
  - 実験用のアドレス
  - 2 進数で 11110 から始まる、先頭から 4 ビット
- **ループバックアドレス**
  - コンピューターや機器自身を表す
  - `127.0.0.1` など

### 6 　グローバル IP とプライベート IP

- **グローバル IP**
  - インターネットで通用する IP アドレス
  - インターネットに参加しているコンピューターや機器に割り当てられる
  - 重複しないように、ICANN（日本では JPNIC）が管理している
  - 企業、個人は契約 ISP からグローバル IP を貸し出してもらっている
- **プライベート IP**
  - 1 つのネットワークの中だけで通用する IP アドレス
  - ネットワーク管理者が自由に割り当てられる
  - 指定できる範囲
    - クラス A
      - `10.0.0.0 ~ 10.255.255.255`
    - クラス B
      - `172.16.0.0 ~ 172.31.255.255`
    - クラス C
      - `192.168.0.0 ~ 192.168.255.255`
  - LAN では、各コンピューターや機器にプライベート IP を割り当てる
- 他のネットワークやインターネットではプライベート IP は通用しない
  - ネットワークをまたいでデータをやり取りする場合は、**ルーター**を使って、**プライベート IP とグローバル IP を変換する**
- LAN の中のコンピューターや機器にグローバル IP をつけると、インターネットを介して外部の侵入者から特定され、攻撃される危険がある
  - そのため、**直接インターネットとデータをやり取りする**サーバーやネットワーク機器には**グローバル IP**を割り当てる
  - **クリアントや LAN の中だけで使用する**サーバーやネットワーク機器には**プライベート IP**を割り当てる

### 7 　サブネットマスクとは

- IP アドレスをクラスに分ける方法の場合、IP アドレスの数がクラスごとに決まっていて、実際のネットワーク構成に応じて数を調整できない
  - そこで、IP アドレスの全 32 ビットのうち、どこからどこまでがネットワークアドレスかを表す**サブネットマスク**と組み合わせて使う「**サブネッティング**」方法が生まれる
  - サブネットマスクを使うことで、**1 つのネットワークを複数のネットワークに分割できる**
- **サブネットマスク**
  - IP アドレスと同様に 8 桁の 2 進数を 4 つ組み合わせる
  - ネットワークアドレスを 1、ホストアドレスを 0 として、10 進数で表記する
  - 仮に、サブネットマスクで、2 進数で先頭から 1 が 24 個、残りが 0 だとする
    - 全 32 ビットの IP アドレスのうち先頭から 24 ビットがネットワークアドレスになる
    - 10 進数で表記すると、 `255.255.255.0`
- サブネットマスクによって、**ホストアドレスの部分からネットワークを表す部分に変わった分**が**サブネット部**
  - **サブネッティングによって分けられたネットワーク**が**サブネット（ワーク）**
- サブネットマスクを使った IP アドレスの例
  - 先頭から 24 ビット分がネットワークアドレスのクラス C の IP アドレスに対して、先頭から 28 ビット分がネットワークアドレスとする「255.255.255.240」のサブネットマスクを使うとする
    - `192.168.0.0 ~ 192.168.255.255` のクラス C プライベート IP
    - `255.255.255.240` のサブネット
    - `192.168.0.0` のプライベート IP と `255.255.255.240` のサブネットを 2 進数にする
      - `192.168.0.0`　 → 　`11000000.10101000.00000000.00000000`
      - `255.255.255.240`　 → 　`11111111.11111111.11111111.11110000`
  - ネットワークアドレスが先頭から 24 ビット分だったのが、サブネットマスクによって、28 ビット分になる
    - サブネットマスクで 1 の部分は、IP アドレスの 0、1 をそのまま書く
      - `11000000.10101000.00000000.00000000`（プライベート IP）
      - `11111111.11111111.11111111.11110000`（サブネットマスク）
      - `11000000.10101000.00000000.0000XXXX`
      - `11000000.10101000.00000000.0000`（2 進数で表せる部分がネットワークを表す部分）
      - `XXXX`（ホストアドレスとして表せる部分）（サブネット部）
  - サブネットマスクで 0 の部分（ホストアドレスを表すサブネット部）の桁で、表せるホストアドレスを計算する
    - `XXXX` の 4 桁から表せるのは 16 個のサブネット
      - `0000`, `0001`, `0010`, `0011`, `0100`, `0101`, `0110`, `0111`, `1000`, `1001`, `1010`, `1011`, `1100`, `1101`, `1110`, `1111`
    - ただ、`0000` と `1111` は特殊なアドレスなので、実際は 14 個
  - 「2 進数で表せる部分がネットワークを表す部分」の末尾に、「表せるホストアドレス」の値を付けて 10 進数にする
    - `11000000.10101000.00000000.0000` と `1010` をつけるとする
    - `11000000.10101000.00000000.00001010` になり、10 進数にすると `192.168.0.10` になる
- サブネットマスクの説明のイラスト
  - [サブネットマスク(subnet mask)とは？](https://www.cman.jp/network/term/subnet/)
- サブネットマスクの計算した結果が見れるところ
  - [サブネットマスク計算(IPv4)／サブネット一覧（早見表）](https://note.cman.jp/network/subnetmask.cgi)

### 8 　 VLSM と CIDR

- IP アドレスとサブネットマスクを組み合わせる方法で、**1 つのネットワーク内ではすべて同じサブネットマスク**を使う
  - しかし、サブネットごとに必要な IP アドレスの数が違うこともあり、効率的ではない
- 1 つのネットワークで異なるサブネットマスクを使える**VLSM（Variable Length Subnet Mask、可変長サブネットマスク）**が考え出される
  - ネットワーク構成に応じてサブネットマスクを変更し、効率よく IP アドレスが使える
- **クラスレスアドレッシング**
  - IP アドレスをクラスで分ける概念をなくして、自由に IP アドレスの数を決められる
- **CIDR（Classless Inter Domain Routing）**
  - クラスレスアドレッシングを実現するために使われる
  - **プレフィックス長**
    - 全体の 32 ビットのうち、先頭から何ビットがネットワークアドレスなのかを表す
    - 「/」とビット数で表す
    - `172.16.10.125/24` だと、ネットワークアドレスが先頭から 24 ビットを表す
- IP アドレスをクラス分けした場合は、全 32 ビットのうち先頭の数字を見れば、どのクラスなのかがわかる
  - IP アドレスだけでネットワークアドレスの部分がどこまでかを判断できる
- クラスレスの CIDR の場合、そこまでがネットワークアドレスの部分なのかを判断するために、IP アドレスに加えてプレフィックス長が必要になる
- JPNIC では、グローバル IP の割り当てを CIDR で行う
  - 企業や個人が ISP からグローバル IP を貸し出すときも、CIDR 表記でグローバル IP アドレスの範囲が指定される

### 10 　ネットワークインターフェイス層で使われる MAC アドレス

- **MAC アドレス（Media Access Control address）**
  - ネットワークインターフェイス層のプロトコル（イーサネット）で使われる識別子
  - NIC 製造時にメーカーによって付けられる
  - コンピューターや NIC を買い換えると MAC アドレスも変わる
  - 全 48 ビットで、16 進数で表記する
  - 先頭から 24 ビット（16 進数で 6 桁）は、製造メーカーを表す OUI
    - **OUI（Organizationally Unique Identifier）**
    - MAC アドレスを管理する IEEE 組織が製造メーカーに割り当てている
  - 残りの 24 ビットは、製造メーカーが管理して割り当てる部分
- **NIC（Network Interface Card）**
  - イーサネットカード、ネットワークカード、LAN カードとも呼ばれる
- ネットワークインターフェイス層は、**直接データをやり取りする相手との通信を担当する**
  - イーサネットがデータを分割してフレームを作成する際、**直接データをやり取りする相手の MAC アドレスを宛先アドレスとして指定**する
  - コンピューターや機器を経由するたびに、経由したコンピューターや機器の MAC アドレスが指定されていく

### 11 　ブロードキャストでネットワーク全体に送信

- データのやり取りの仕方
  - **ユニキャスト**
    - コンピューターや機器が 1 対 1 の関係
  - **ブロードキャスト**
    - 1 台のコンピューターや機器からネットワーク全体にデータを送る
    - 相手の識別子など、**データをやり取りするときに必要となる情報を取得する際に使われる**
      - 相手の識別子がわからない状態では、相手を特定してデータを送れないので、ネットワーク全体に問い合わせをする
    - ブロードキャストでデータを送るときは、ブロードキャスト専用の識別子（**ブロードキャストアドレス**）を使う
    - **リミテッドブロードキャスト**
      - 同じネットワーク全体に送る
      - IP アドレスの全 32 ビットが 2 進数で 1、10 進数で `255.255.255.255`
    - **ディレクティッドブロードキャスト**
      - 指定したネットワークアドレス内全体に送る
      - ネットワークアドレス部分をすべて 2 進数の 1 にしたアドレス
        - `192.168.2.0/24` というネットワークだったら、 `192.168.2.255` がブロードキャストアドレス
      - 他のネットワークから特定のネットワークへブロードキャストしたい場合
        - `192.168.2.0/24` ネットワークにブロードキャストしたいとする
        - データはいったん `192.168.2.0/24` のネットワークまで運ばれる
        - `192.168.2.0/24` に着いた時点で `192.168.2.0/24` 全体にブロードキャストされる
    - MAC アドレスでは、全 48 ビットがすべて 2 進数の 1、16 進数で `FF:FF:FF:FF:FF:FF` がブロードキャストアドレスになる
  - **マルチキャスト**
    - 特定の複数の相手に送る

### 12 　マルチキャストで特定のグループに送信

- **マルチキャスト**
  - 特定のグループに属する複数のコンピューターや機器に対してデータを送る
  - ルーティング時にも使われる
  - サーバーが送るデータは 1 つだけで、途中のネットワーク機器で複製されて、複数の相手に送られる
    - ユニキャストだと、複数のクライアントの分だけ同じデータを送ることになる
- **マルチキャストグループ**
  - マルチキャストの受信側が参加する
  - マルチキャストに対応しているソフトウェアで、マルチキャストグループ用として決めた IP アドレスを設定する
  - マルチキャストグループ用の IP アドレス宛にデータを送ると、マルチキャストキャストグループに参加しているすべてのコンピューターや機器にデータが届く
- **IP のマルチキャストアドレス**
  - クラス D の範囲 `224.0.0.0 ~ 239.255.255.255` を使う
  - `224.0.0.0 ~ 224.0.0.255` は特定の用途に使う
  - `224.0.1.0 ~ 238.255.255.255` はインターネットで使用されるために、IANA によって管理される
  - `239.0.0.0 ~ 239.255.255.255` は、LAN の用に閉じられたローカルネットワークで自由に使う
- **マルチキャスト用の MAC アドレス**
  - マルチキャスト用として設定した IP アドレスから割り出す
    - MAC アドレスの全 48 ビットのうち、先頭から 25 ビット分はマルチキャスト用として決められている
    - 残りの 23 ビット分は、IP のマルチキャストアドレスから割り出す
  - ユニキャスト用の MAC アドレスとは別に、マルチキャスト用の MAC アドレスが作られる
  - マルチキャストグループが違えば設定した IP アドレスも変わるので MAC アドレスも異なる
- インターネットで使うマルチキャストアドレスの一覧
  - [IPv4 Multicast Address Space Registry](https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml)

### 13 　 ARP で IP アドレスに該当する MAC アドレスを求める

- データをやり取りする相手の IP アドレスはユーザーが指定するが、MAC アドレスは指定しない
  - しかし、MAC アドレスがわからないままだとデータのやり取りができない
- **ARP（Address Resolution Protocol）**というプロトコルを使って MAC アドレスを調べる
  - ARP はインターネット層に属する
- MAC アドレスを知りたい相手が同じネットワークにいる場合
  - ARP は探したい IP アドレスを持つコンピューターや機器に MAC アドレスのリクエスト用のパケットを作る
  - 下位のネットワークインターフェイス層のイーサネットに渡す
  - イーサネットはパケットをフレームにして、**ブロードキャスト**で送る
  - フレームはネットワークに参加しているすべてのコンピューターや機器に届く
  - 受け取った側は、ARP のリクエストパケットを見て、自分の IP アドレスが該当するのであれば、ユニキャストで返信する
  - これで、送信側はデータをやり取りしたい相手の MAC アドレスがわかる
  - ARP で知った IP アドレスと MAC アドレスの情報を**ARP テーブル**として保存しておき、今後のデータのやりたりに使う
- MAC アドレスを知りたい相手が別のネットワークにいる場合
  - パケットをネットワークの出入り口（ゲートウェイ）に送る
  - ただし、ゲートウェイの MAC アドレスが分からないので、ゲートウェイの IP アドレスを指定したリクエストのパケットを作る
- ARP は IP アドレスから MAC アドレスを求める
  - MAC アドレスから IP アドレスを求める場合は、RARP（Reverse ARP）というプロトコルを使うが、現在はあまり利用されてない

### 14 　次世代の IP「IPv6」とは

- **IPv6**
  - アドレス長
    - 128 ビット
      - 作成できる IP アドレスの数は 2 の 128 乗（約 340 澗個）
  - 表記
    - 16 ビットずつ「:」で区切って 16 進数で表す
- **IPv4**
  - アドレス長
    - 32 ビット
      - 作成できる IP アドレスの数は 2 の 32 乗（約 43 億個）
- IPv6 アドレス
  - インターネット層の識別子
  - 基本的な働きは IPv4 と同じ
  - IPv6 アドレスの構造
    - **サブネットプレフィックス**
      - IPv4 アドレスのネットワークアドレスに相当する
    - **インターフェイス ID**
      - ホストアドレスに相当する
  - 通信相手に夜挙動の違い
    - ユニキャストアドレス
      - 1 対 1 でやり取りするときに使用する
    - マルチキャストアドレス
      - 一度に多くの機器と通信する
    - エニーキャストアドレス
      - グループ内の 1 つの機器とだけやり取りする
  - アドレス数が十分確保できることから、**すべての機器にグローバルアドレスを割り振ることもできる**
    - NAT でプライベート IP とグローバル IP を変換する必要もなくなる
    - パケットの暗号化機能を組み込めたり、モバイルで使用しやすいなどもある

---

## 第 4 章　 LAN で使われている技術

- ルーター
- ルーティング
- LAN 内で使われるディレクトリサービス

### 1 　 LAN と WAN

- **WAN（Wide Area Network）**
  - 離れた場所にある LAN を結んだネットワーク
  - 一般的に企業の LAN と LAN を結ぶものを WAN と呼ぶ
  - インターネットは誰もが自由に使用できるが、WAN は通信事業者と契約してはじめて使える
  - WAN はどのコンピューターや機器が参加しているかを把握できる
  - WAN は LAN と同じ用に閉じられたネットワーク
- LAN と LAN の間を結ぶには、通信事業者が提供するネットワークを使用する
  - 通信事業者が提供するネットワーク
    - 回線を占有しない
      - **パケット交換方式**
        - 通信速度が速く、複数の LAN 間でデータをやり取りできる
        - **IP-VPN**、**広域イーサネット**、**フレームリレー**などのサービスがある
    - 回線を占有する
      - **回線交換方式**
        - データを送りたいときに、送りたい相手を指定して回線を確保する方式
        - 支店間を結ぶ内戦電話サービスなどに向いている
      - **専用線方式**
        - 2 点間を専用の回線で結び、データをやり取りする方式
        - 高速で安定したデータのやり取りができるが、コストがかかる
- **IP-VPN**
  - IP を使う IP ネットワークの中に、仮想的に LAN と LAN を結ぶネットワークを作る技術
  - 通信事業者が専有する IP 網を使用して、LAN と LAN を接続する
- **広域イーサネット**
  - イーサネットで LAN 間を結ぶ

### 2 　ゲートウェイを設置してほかのネットワークと接続する

- **ゲートウェイ**
  - ネットワークから別のネットワークへつながる出入り口
  - 役割の 1 つとして、**異なる仕組みを採用するネットワーク同士でデータをやり取りする**
    - インターネットと LAN の間でデータのやり取りをする時、LAN の中ではプライベート IP、インターネットではグローバル IP を使用する
    - 使用する IP が違うのでデータをやりとりができない
    - そこで、プライベート IP とグローバル IP の両方を持つ機器（**ゲートウェイ**）を介することで、データのやり取りが可能になる
  - ゲートウェイで複数のネットワークに参加するので、**複数のネットワークインターフェイスを備えたハードウェア**を使用する
    - **ルーター**を使うことが多いが、ネットワークインターフェイスを複数備えたコンピューターを**ゲートウェイサーバー**として使用することも可能
  - ゲートウェイは参加しているネットワークごとに IP アドレスを持っている
    - 参加しているネットワークで採用しているプロトコルが異なる場合、プロトコルも両方に対応する
- **デフォルトゲートウェイ**
  - ネットワーク内のコンピューターや機器が他のネットワークのコンピューターや機器にデータを送るときに指定した IP アドレスのゲートウェイを通るように設定する
  - 指定されたゲートウェイが**デフォルトゲートウェイ**
- **セキュリティ**
  - 他のネットワークへ送られるデータや、他のネットワークから届くデータは必ずゲートウェイを通る
  - ゲートウェイでデータをチェックし、危険なデータを排除する

### 3 　データの道筋を決めるルーティング

- **ルーティング**
  - TCP のインターネット層で、IP が担う役割の 1 つにルーティングがある
  - **どのルートを通ってデータをやり取りすればよいのかを選択する**
    - **経路選択**
  - ルーティングを行う機器は**ルーター**
- **ルーティングテーブル**
  - どのルートを選べばよいのかを判断するために「ネットワークアドレスが特定の IP アドレス宛にデータを送る場合、このルーターに送る」という情報を集めたもの

### 4 　スタティックルーティングとダイナミックルーティング

- ルーティングテーブルを作る方法
  - **スタティックルーティング**
    - ネットワーク管理者が手作業で登録する
    - ネットワークの変更時の情報を手作業で変更する必要がある
    - 障害が起きた場合、管理者が設定を変更し、復旧したら元に戻すことになる
    - ルーター自身がルーティングテーブルを作る作業を行わなくてもいいので、ルーターの負担が少なく済む
    - 小規模ネットワーク、特定の経路にルーティングすることが決まっている場合に浮かう
  - **ダイナミックルーティング**
    - ルーター同士が**ルーティングプロトコル**を使って、情報を交換してルーティングテーブルを作る
    - 初期設定時に自動的にルーティングテーブルが作られるので、管理の手間がかからない
    - 障害が起きても、別の経路を通るように情報が切り替わる
    - 他のルーターと情報を交換し、ルーティングテーブルを作成、更新するので、ルーターとネットワークに負担がかかる

### 5 　ルーティングプロトコルを使ってルーター同士が通信

- ルーターがルーティングテーブルを作るために使うルーティングプロトコル
  - AS 内のルーター同士が使うもの
    - IGP（Interior GateWay Protocol）
  - AS 外のルーター同士が使うもの
    - EGP（Exterior GateWay Protocol）
- **AS（Autonomous System、自律システム）**
  - **インターネットを構成しているネットワークの単位**
  - 巨大なネットワークでは全体を管理することは難しいので、プロバイダや企業などを 1 つの簡易としてネットワークを形成し、管理する
  - この 1 つ１つが AS
  - どの AS かを区別するため、**AS 番号**が付けられる
- **AS 番号**
  - グローバル AS 番号
    - インターネットで通用する AS 番号
    - ICANN が管理する
  - プライベート AS 番号
    - グローバル AS 番号を持つネットワーク内で使う AS 番号で、インターネットでは通用しない
- ルーティングプロトコルのルーティングテーブルの情報の交換方法
  - ディスタンスベクター型
    - 隣接するルーター同士で情報を交換する
  - リンクステート型
    - リンクの情報をすべてのルーターに送る
  - 各ルーターは、送られてきた情報を元に、ネットワ 0 区全体を把握するデーターベースを作る

### 7 　 DHCP サービスの仕組み

- **DHCP サービス**
  - IP アドレス、デフォルトゲートウェイ、サブネットマスクなどのデータのやり取りに必要な情報を自動的に設定するネットワークサービス
  - **DHCP（Dynamic Host Configuration Protocol）**
  - TCP/IP のアプリケーション層に属するプロトコル
  - トランスポート層のプロトコルとして UDP を使用する
- DHCP のメリット
  - 割り当てる IP アドレスの範囲を指定することで、IP アドレスの管理の手間が省ける
  - ユーザーに設定情報を配布したり、設定方法を指導したり、代行する必要がない
  - ユーザー側も設定を行わなくても良い
- DHCP サーバーと新たにネットワークに参加したクライアントとのデータの流れ
  - クライアントは、DHCP サーバーが存在したら返信をもらうように、ブロードキャストをする
    - **DHCP DISCOVER**
  - DHCP サーバーは DHCP DISCOVER の返信としてユニキャスト出クライアントにデータを送る
    - **DHCP OFFER**
  - クライアントは DHCP OFFER の中から使用する DHCP サーバーを 1 つ選び、使用する DHCP サーバーの情報を送ってもらうようにブロードキャストをする
    - **DHCP REQUEST**
  - DHCP REQUEST が送られた DHCP サーバーは**アドレスプール**から 1 つ IP アドレスを選び、その IP アドレスなど必要な情報を含んだユニキャストでクライアントに送る
    - **DHCP ACK**
  - DHCP ACK を受け取ったクライアントは、含まれた情報を設定する
- **アドレスプール**
  - クライアントに割り当てる IP アドレスの範囲
- DHCP には IP アドレスの有効期限を設けて、期限を過ぎたら再度 IP アドレスを割り当てる機能がある
  - クライアントの IP アドレスは時間経過によって変わる
  - 常に同じ IP アドレスにする必要があるサーバーには、ネットワーク管理者が手作業で IP アドレスを割り当てる

### 8 　ディレクトリサービスを導入する

- ディレクトリサービス
  - ネットワークに参加しているコンピューターや機器、ユーザーの情報などを集めた DB を作り、一元管理するネットワークサービス
  - ファイルサーバーなどのサーバーやプリンターをどのユーザーがどのように利用できるのかは、各サーバーソフトで 1 つ 1 つ設定して管理する
  - しかし、それぞれで管理すると手間がかかるし、変更も容易ではない
  - そこで、1 つにまとめて管理するのがディレクトリーサービスの考え方
- ソフト
  - Windows Server
    - **Active Directory**
  - UNIX 系 OS
    - **OpenLDAP**
- ディレクトリーサービスを利用するには
  - ディレクトリーサービスを提供するサーバーを構築する
  - サーバーでユーザーやコンピューター、機器の情報を一元管理する

### 9 　 NAT と NAPT

- プライベート IP が割り当てられている LAN の中のコンピューターがインターネットに接続する場合
  - グローバル IP がないのでそのままでは利用できない
  - そこで、LAN からインターネットへの出入り口となるゲートウェイで、**グローバル IP とプライベート IP を交換する**
  - **NAT**と**NAPT（IP マスカレード）**がある

### 10 　 VPN の仕組み

- **VPN（Virtual Private Network）**
  - 複数のユーザーが共同で使用しているネットワークの中に、仮想的にネットワークを作る仕組み
- IP-VPN
  - 通信事業者が所有する IP 網を利用する VPN
  - LAN と LAN を結ぶ方法として利用される
- **インターネット VPN**
  - インターネットを利用する VPN
  - 外出先から社内の LAN を利用するときなどに使われる
- VPN のプロトコル
  - IPSec（Security Architecture for Internet Protocol）
  - PPTP（Point-to-Point Tunneling Protocol）
  - L2TP（Layer 2 Tunneling Protocol）
- WindowsOS では、IPSec と L2TP を組み合わせた方式（L2TP/IPSec）と PPTP を標準で装備している
- VPN のポイント
  - **暗号化**
    - VPN では、インターネットなどの多くのユーザーが利用するネットワークを使い、閉じられたネットワークの中野コンピューターとデータをやり取りする
    - 途中でデータを盗まれたり、改ざんされる危険性がある
    - そのため、データを暗号化してやり取りする
  - **トンネリング**
    - パケットをカプセル化してやり取りする
    - OSI 参照モデルのどの層のパケットをカプセル化するかによって、レイヤー 2 トンネリング、レイヤー 3 トンネリングなどと呼ぶ
  - **認証**
    - 正規のデータのやり取りであるかを認証する機能が装備されている
    - **IKE（Internet Key Exchange）**などが使われる
- VPN を利用するには
  - VPN に対応したゲートウェイを導入する
  - 外出先のコンピューターからインターネット VPN を利用する場合、VPN クライアントソフトを導入する必要がある

### 11 　無線 LAN の仕組み

- 無線 LAN
  - OSI 参照モデルの物理層にケーブルを使わず、赤外線や電波を使用してデータをやり取りする LAN
- アクセスポイント
  - 有線で構築された LAN に無線 LAN を導入する場合に必要な機器
- 無線 LAN の規格
  - IEEE が策定した**IEEE 802.11**が広く普及している
  - 現在主に使われているのは、**IEEE 802.11n**、**IEEE 802.11ac**
- Wi-Fi
  - 無線 LAN 機器を扱うメーカーの業界団体
  - 規格名ではない
  - **Wi-Fi Alliance**を取得している機器であれば、ほかのメーカーの機器とも問題なくデータをやり取りできることが保証されている
- 無線 LAN のセキュリティ
  - 設定時に**WPA2-AES（WPA-AES、WPA2）**を選ぶ
  - 不正侵入を防ぐために、LAN 接続を確認する技術規格「**IEEE 802.1X**」を導入して、許可されたコンピューターや機器だけが接続できるように制限する
  - 誰もが見られる無線ネットワークの識別子「**ESSID**」（**SSID**）に企業名をつけると、簡単に企業名を特定されてしまう

### 12 　イーサネットは CSMA/CD でデータの衝突を防ぐ

- **CSMA/CD（Carrier Sense Multiple Access with Collision Detection）**
  - ネットワークインターフェイス層のプロトコル（イーサネット）に採用されている仕組み
  - コリジョンを起こさないようにしつつ、起きた場合にも対処する役割を持つ
  - 回線にデータが流れていないかを確認し、空いていればデータを送る
    - **Carrier Sense**
  - 1 本の回線を複数のコンピューターや機器が共有して使う
    - **Multiple Access**
  - コリジョンが起こったら、それを検知してしばらく待ってから、再び回線の確認から始める
    - **Collision Detection**
- **半二重通信**
  - 1 本の回線を送信と受信の両方に使う通信方式
  - 同時に送受信ができない
  - 同時に双方向からデータがやってくることがあり、データが衝突してしまう
    - **コリジョン**
- **全二重通信**
  - 複数の回線を使い、同時に送受信できる方式

---

## 第 6 章　ネットワークセキュリティを強固にする

### 1 　ネットワークを利用するならセキュリティは必須

- 企業ネットワークのさまざまな危険
  - 機密データを盗まれる
  - 「踏み台」にされる
    - クラッカーはあるネットワークに侵入して、そこから他のネットワークを攻撃する
    - その時、最初に最初に侵入されたネットワークを**踏み台**と呼ぶ
    - 踏み台にされたネットワークから攻撃されているように見えるので、本来は被害者なのに加害者にされてしまうこともある
  - ウイルス
  - 内部からの情報漏えい
  - 不適切なネット利用によるトラブル

### 2 　ファイアウォールを構築して不正侵入を防ぐ

- LAN とインターネットを行き来するデータは、必ず**ゲートウェイ**を通る
  - ゲートウェイに危険なデータかどうかを判断する機能を持たせ、行き来するデータをチェックして安全と判断したデータだけを通す
  - この仕組みが**ファイアウォール**
- **アプライアンス**
  - ファイアウォールとして使用することを目的として設計された機器
  - 設定が簡単にできる
- ルーターもゲートウェイとして使用するので、ファイアウォールの機能が組み込まれている
  - 細かい設定はできない
  - 小規模のネットワークでネットワーク内にウェブサーバーなどインターネットに公開しているサーバーが存在しない場合には、ルーターのファイアウォール機能だけで済ませるケースもある

### 3 　ファイアウォールの種類

- ファイアウォールの種類と、扱えるレイヤーについて
  - |      TCP/IP レイヤー構造       | アプリケーションレベル<br>ゲートウェイ | サーキットレベル<br>ゲートウェイ | パケットフィルタリング |
    | :----------------------------: | :------------------------------------: | :------------------------------: | :--------------------: |
    |       アプリケーション層       |                   ◯                    |                ☓                 |           ☓            |
    |        トランスポート層        |                   ◯                    |                ◯                 |           ☓            |
    |        インターネット層        |                   ◯                    |                ◯                 |           ◯            |
    | ネットワークインターフェイス層 |                   ◯                    |                ◯                 |           ◯            |
- **アプリケーションレベルゲートウェイ**
  - ゲートウェイを通過するデータの中身までをチェックして判断する
- **サーキットレベルゲートウェイ**
  - TCP が担当するデータのやり取りの手順を監視して、通してよいデータかどうかを判断する
  - **汎用プロキシ**
  - 実際のネットワークではあまり使われていない
- **パケットフィルタリング**
  - IP が作ったデータグラムのヘッダーを見て、IP アドレスやポート番号などの情報を元に、通してよいデータかどうかを判断する
  - ネットワーク機器で行うのが一般的
  - **ステートフルパケットインスペクション**も普及している
    - トランスポート層で行われるデータのやり取りの手順を記録し、通してよいデータがどうかを判断する

### 4 　 DMZ を構築する

- ウェブサーバーなど、インターネットからの接続を受け付けるサーバーを構築する場合、ファイアウォールでは危険なデータの遮断ができない
  - インターネットからの接続をすべて許可すると、クライアントやサーバーに対して接続を試みる不正データの侵入も許してしまう
  - そこで、インターネットかたの接続を受け付けるサーバーと、受け付ける必要のないコンピューターを別々のネットワークに分ける
- **DMZ（DeMilitarized Zone）**
  - インターネットからの接続を受け付けるネットワーク
  - DMZ 内のサーバーに不正侵入されたとしても、DMZ とクライアントが属する内部ネットワークとはファイアウォールで隔てられているので、被害を DMZ 内で食い止められる
- DMZ には、ウェブサーバー、メールサーバー、DNS サーバーなど、**インターネットからの接続を受け付ける必要があるサーバーだけを設置する**
  - ウェブサーバーと DB サーバーを連携させるウェブアプリを稼働する場合
    - DB サーバーは DMZ ではなく、内部のネットワークに設置する
    - ファイアウォールでウェブサーバーから内部の DB サーバーへの接続だけをピンポイントで許可する
- DMZ を作るには、3 つのネットワークインターフェイスを備えるハードウェアをファイアウォールとして使う
  - インターネットから DMZ 内のサーバーに接続するデータは DMZ へ送る
  - それ以外のデータは危険データとして判断するよう設定する
- ファイアウォールを 2 つ配置して、ファイアウォール同士の間に DMZ を設ける方法もある

### 5 　 IDS と IPS の仕組み

- HTTP リクエストが短時間に大量に送られてくる場合
  - ウェブサーバーは処理しきれず、停止する
  - サーバーを攻撃する手口として知られている**DDos 攻撃**
- **データそのものには不審な点がなくても、ネットワークに被害を与える攻撃方法がある**
  - データをチェックして、安全かどうかを判断するファイアウォールだけでは防げない
- データの動きを監視して危険と思われるデータを発見するシステム
  - **IDS（Intrusion Detection System、侵入検知システム）**
    - 検知したら、ネットワーク管理者にメールなどで通知する
    - IDS 自体にデータを遮断したり、対策をとることはない
  - **IPS（Intrusion Protection System、侵入防御システム）**
    - 通知だけでなく、データの遮断など遮断の対策も自動的に行う
- IDS、IPS が危険と思われるデータかどうかを判断する方法
  - よくある攻撃手口を登録しておき、同じふるまいをするデータを検知する方法
  - 「普通の状態」の範囲を登録しておき、それを超えたら異常だと判断する方法
- IDS の種類
  - **ネットワーク型 IDS（NIDS）**
    - ネットワークに流れるデータを監視する
    - アプライアンスを利用するのが一般的
  - **ホスト型 IDS（HIDS）**
    - サーバーに導入してサーバーが受け取るデータやサーバー OS の通信ログなどを監視する

### 6 　ウイルスとは

- ウイルス
  - 悪意のあるプログラム
  - 特徴
    - 他のファイルに取り付く
    - 自己増殖する
    - 自動的に実行される
  - 代表的な種類
    - ワーム
      - 単独のファイルとして存在する
      - 自己増殖する
    - トロイの木馬
      - 便利なプログラムに見せかけて、実は悪さをするプログラム
    - マクロウイルス
      - マクロ機能を悪用するウイルス
    - ボット
      - コンピューターを乗っ取るウイルス
      - 複数のボットが連携すると、ボットネットになる
    - など
  - 不正なソフトウェアを総称として**マルウェア**と呼ぶ
- 必ずウイルス対策ソフトを導入する

### 7 　ウイルス対策システムを導入する

- ウイルス対策ソフト
  - ゲートウェイ型
    - ゲートウェイでウイルスチェック
    - ウイルスがネットワーク内のコンピューターに到達する前に、出入り口でシャットアウトできる
  - サーバー型
    - クライアントにデータがダウンロードされる前にウイルスの有無をチェックできる
    - ウイルス対策ソフトを導入したサーバーで扱っているデータしかチェックしていない
  - クライアント型
    - 記録媒体で持ち込まれるウイルスもチェックできる
    - ウイルス対策ソフトの管理をユーザーする必要がある
    - 企業向けに、ネットワーク管理者が各クライアントのウイルス対策ソフトを集中管理できる製品が用意されている

### 8 　コンテンツフィルタリングとは

- **コンテンツフィルタリング**
  - アプリケーションレベルゲートウェイでデータの中身を見て不適切なデータを遮断する
  - ネットワークを通ったデータは基本的に何でもチェックできる
    - 送受信するメールの内容
    - 閲覧したウェブページの URL や内容
    - 社内のクライアントからネットの掲示板やブログに投稿した内容
    - など
  - 暗号化技術を使えば、データの中身まではわからないけど、暗号化技術を使用していることはわかる
  - 各クライアントのネット使用状況をチェックする機能もあり、極端にウェブサイト閲覧時間が長いクライアントもわかる
- **セキュリティポリシー**
  - コンテンツフィルタリングを導入する際、何が不適切とするかを定める
  - 社員全体にコンテンツフィルタリングを行うこと、どのようなものをチェックしているのかなどを伝える
  - **こっそりインターネットの使用状況を監視するのがコンテンツフィルタリングの目的ではない**

### 10 　社内からの書込は相手に簡単にわかってしまう

- クライアントからインターネットの掲示板に文章を投稿したとする
  - 感覚的には、一方的に文字データを掲示板に送っているように思える
  - 実際は、**クライアントとサーバーの間でデータをやり取りしている**
  - **サーバーにはクライアントのグローバル IP がわかっている**
- サーバー管理者がゲートウェイのグローバル IP をもとに、**whois**で検索すると、企業や団体名がすぐわかる

### 11 　ウェブサービスで使われる暗号化技術「SSL/TLS」

- インターネットでやり取りされるデータは、誰でも内容を見られる状態で流れている
  - データを盗み見たりデータを改ざんされる危険性がある
- **暗号化技術**
  - ID やパスワード、個人情報などの盗み見られては困るデータをやり取りする際に使う
  - **データの暗号化**
  - **認証**
    - なりすましの防止
  - **改ざんの検出**
- **SSL/TLS（Secure Socket Layer/Transport Layer Security）**
  - TCP/IP のアプリケーション層とトランスポート層の間に位置する
  - HTTP、SMTP、POP などのプロトコルと組み合わせて暗号化できる
  - データをやり取りする相手が本物かどうかを認証する方法
    - SSL/TLS サーバー証明書を使う
- **ハッシュ**
  - 改ざん検出時に使う
  - 送信側は、データを元にハッシュ値を計算し、データと一緒に送る
  - 受信側は届いたハッシュ値が同じならデータも同じで、改ざんされていないと判断する

---

## 第 7 章　ネットワークの構築と管理

- ネットワークを構築するにあたっての基本知識や管理、運用
- 基礎となる構成の発案
- 実際の構築
- その後の運用

### 1 　ネットワーク構成を考える

- 決めること
  - **ネットワークで何をするか**
  - **どんなネットワークにしたいか**
- ネットワークを構築して何をするのか
  - 1 つ 1 つ書き出す
  - もっと詳しく書ける項目があれば、それも書き出す
- どんなネットワークにしたいか
  - 要望を書き出す
  - ネットワーク構成に盛り込む項目、コストなどに余裕があれば行う項目に分けて優先順位をつける
- ネットワーク管理者、管理部門、ネットワーク利用者に意見を聞く
  - 管理側だけでは気づかない改善点が見つかる可能性がある

### 2 　ネットワーク構成図を描く

- **ネットワーク構成図**
  - 図にすることで、具体的なイメージがわく
  - MS ソフトの**Visio**とか表計算ソフトなどで描く
- **ネットワークのグループ分けから始める**
  - 1 つのネットワークを、複数の小さなグループに分割する
  - グループは小さなネットワークになる
  - グループ分けする時の基準を決めて、同じものをまとめていく
    - 「利用できるサーバーや機器」、「インターネットからの接続を受け入れるかどうか」など
- **論理構成図**
  - ネットワークとしてどのような構成になっているのかを表す図
- **物理構成図**
  - 実際の配線や機器の設置場所を記した図

### 5 　ネットワークを小さなネットワークに分割する

- 1 つのネットワークをふうくすうの小さなネットワークに分割する
- ネットワーク構成図を描く際に分けたグループが小さなネットワークになる
  - グループの数だけ小さなネットワークが必要
- 小さなネットワークに分割することのメリット
  - 管理がしやすくなる
  - ネットワークの負荷を軽減できる
- 1 つのネットワークを分割する方法
  - **サブネッティング**と**VLAN**
  - **サブネッティング**
    - サブネットマスクを使ってネットワークアドレスを表す部分を増やし、小さなネットワーク（サブネット）を作る
    - サブネットマスクは、必要なサブネット数から割り出す
    - LAN の場合、プライベート IP を使うので、すべて同じサブネットマスクの値にしてわかりやすくするのが一般的
  - **VLAN**
    - LAN の中で仮想的に小さい LAN を作るもの
    - 物理的に離れた場所にあるコンピューターや機器を 1 つの VLAN にすることもできる
    - VLAN 機能を備えたスイッチやルーターで設定するだけで完成するが、これだけでは他のネットワークとのデータのやり取りができない
      - VLAN ごとに異なるネットワークアドレスを持つ IP アドレス範囲を割り当てて別々のネットワークとして区別し、ルーターで他のネットワークに接続する

### 6 　インターネットに接続する

- 企業ネットワークをインターネットに接続するには、法人向けのインターネット接続サービスを利用する
- 回線事業者や ISP と契約して、**回線設備**と**グローバル IP**を用意する
  - ほかにもインターネット接続用の DNS サーバー、AS 番号が必要
  - インターネット接続用の DNS サーバーは企業ネットワーク内に構築するのが一般的
  - AS 番号は、ISP が取得している AS 番号を使うので、割り当ててもらう必要はない
- 利用する回線
  - ADSL、FTTH、専用線など
  - LAN と LAN をつないで、WAN を作る場合
    - IP-VPN や広域イーサネット、専用線などを利用する
- 社内にウェブサーバーなどのインターネットに公開するサーバーを設置する場合
  - 社外からのアクセスが可能になるよう、常に同じグローバル IP アドレスを使用する**固定 IP**サービスを利用する
  - ISP によって、オプションとして固定 IP を提供するところや、法人向けでも固定 IP とそうでないサービスを別々のコース名称で提供しているところがある
- **固定 IP**サービスで割り当てられるグローバル IP の数
  - 1、8、16、32…という単位で契約する
  - ウェブサーバー、メールサーバー、DNS サーバを公開する場合は、8 個で契約することが多い

### 8 　冗長化とは

- **冗長化**
  - 障害が起きたときのために呼びを用意しておくこと
  - サーバーに障害が起きたことを考えて同じサーバーを複数台用意する
  - 冗長化の対象に応じて、**ネットワークの冗長化、ストレージの冗長化**がある
- **サーバーの冗長化**
  - 1 台に障害が起きても残りのサーバーがネットワークサービスを提供する
- **ストレージ**
  - ハードディスクに代表されるデータ記録装置
  - 複数台のハードディスクを 1 台のハードディスクのように使える**RAID**技術を使い、同じデータを複数のハードディスクに保存しておく方法がある
- **一方に障害が起きても、もう一方が正常に動作することを考えて用意する**
  - 単に同じものを 2 つ用意するのではない
  - インターネット回線を 2 回線確保して冗長化することで、ISP のネットワークに障害が起きても、もう一方が使えるようにする
  - 電気トラブルで障害が起きることを考えて、予備は物理的に別の場所に設置する
